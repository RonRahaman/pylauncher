

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pylauncher &mdash; PyLauncher 2.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="PyLauncher 2.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">PyLauncher 2.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pylauncher</h1><div class="highlight"><pre>
<span class="n">docstring</span> <span class="o">=</span> \
<span class="sd">&quot;&quot;&quot;pylauncher.py version 2.3 UNRELEASED</span>

<span class="sd">A python based launcher utility for packaging sequential or</span>
<span class="sd">low parallel jobs in one big parallel job</span>

<span class="sd">Author: Victor Eijkhout</span>
<span class="sd">eijkhout@tacc.utexas.edu</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">changelog</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">Change log</span>
<span class="s">2.3</span>
<span class="s">- supports operation on a MIC</span>
<span class="s">2.2</span>
<span class="s">- introduced ClusterName; HostName is now really the hostname</span>
<span class="s">- unit tests now work outside of a cluster.</span>
<span class="s">2.1</span>
<span class="s">- renamed TACCHostPool -&gt; DefaultHostPool</span>
<span class="s">- proper prefixer for ClassicLauncher</span>
<span class="s">2.0</span>
<span class="s">- complete redesign</span>
<span class="s">1.6</span>
<span class="s">- SLURM support</span>
<span class="s">1.5</span>
<span class="s">- Adding affinity control</span>
<span class="s">1.4</span>
<span class="s">- CD&#39;ing to current directory fixed</span>
<span class="s">1.3</span>
<span class="s">- Tmp directory now internal to job instead of global variable;</span>
<span class="s">can be specified as kwarg to both Job and LauncherJob</span>
<span class="s">- Completion testing now takes only file system access per tick</span>
<span class="s">1.2</span>
<span class="s">- Unique tmp directory</span>
<span class="s">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">hostlist</span> <span class="kn">as</span> <span class="nn">hs</span>

<span class="k">class</span> <span class="nc">LauncherException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A very basic exception mechanism&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="k">print</span> <span class="nb">str</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">str</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">str</span>
                                
<span class="n">debugtracefile</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">def</span> <span class="nf">MakeDebugtracefile</span><span class="p">(</span><span class="n">launcherdir</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">debugtracefile</span>
    <span class="n">debugtracefile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">launcherdir</span><span class="o">+</span><span class="s">&quot;/debugtracefile&quot;</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">runtime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">DebugTraceMsg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="n">sw</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">runtime</span><span class="p">,</span><span class="n">debugtracefile</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sw</span><span class="p">:</span> <span class="k">return</span>
    <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">:</span>
        <span class="k">print</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">longprefix</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="c">#&quot;[t=%5.3f] &quot; % time.time()-runtime</span>
    <span class="k">if</span> <span class="n">prefix</span><span class="o">!=</span><span class="s">&quot;&quot;</span><span class="p">:</span>
        <span class="n">longprefix</span> <span class="o">+=</span> <span class="n">prefix</span><span class="o">+</span><span class="s">&quot;: &quot;</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">longprefix</span><span class="o">+</span><span class="n">l</span>
        <span class="n">longprefix</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">longprefix</span><span class="p">)</span><span class="o">*</span><span class="s">&quot; &quot;</span>
    <span class="k">if</span> <span class="n">debugtracefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">debugtracefile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">fsync</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">CloseDebugtracefile</span><span class="p">():</span>
    <span class="n">close</span><span class="p">(</span><span class="n">debugtracefile</span><span class="p">)</span>

<span class="n">randomid</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">def</span> <span class="nf">RandomID</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">randomid</span>
    <span class="n">randomid</span> <span class="o">+=</span> <span class="mi">7</span>
    <span class="k">return</span> <span class="n">randomid</span>
<span class="k">def</span> <span class="nf">RandomDir</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">&quot;pylauncher_tmpdir</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">RandomID</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">NoRandomDir</span><span class="p">():</span>
    <span class="n">dirname</span> <span class="o">=</span> <span class="n">RandomDir</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/rm -rf </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dirname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dirname</span>
<span class="k">def</span> <span class="nf">MakeRandomDir</span><span class="p">():</span>
    <span class="n">dirname</span> <span class="o">=</span> <span class="n">NoRandomDir</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dirname</span>
<span class="k">def</span> <span class="nf">RandomFile</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
    <span class="n">fn</span>  <span class="o">=</span> <span class="s">&quot;pylauncher_tmpfile&quot;</span>
    <span class="k">if</span> <span class="n">base</span><span class="o">!=</span><span class="s">&quot;&quot;</span><span class="p">:</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">+</span><span class="s">&quot;-&quot;</span><span class="o">+</span><span class="n">base</span>
    <span class="k">return</span> <span class="n">fn</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">RandomID</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">RandomNumber</span><span class="p">(</span><span class="n">tmax</span><span class="p">,</span><span class="n">tmin</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span> <span class="n">tmin</span><span class="o">+</span><span class="p">(</span><span class="n">tmax</span><span class="o">-</span><span class="n">tmin</span><span class="p">)</span><span class="o">*</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="p">)</span>

<div class="viewcode-block" id="CountedCommandGenerator"><a class="viewcode-back" href="../testing.html#pylauncher.CountedCommandGenerator">[docs]</a><span class="k">class</span> <span class="nc">CountedCommandGenerator</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;This class is only for the unit tests, it produces a string of `echo 0&#39;, `echo 1&#39;</span>
<span class="sd">    et cetera commands.</span>

<span class="sd">    :param nmax: (keyword, default=-1) maximum number of commands to generate, negative for no maximum</span>
<span class="sd">    :param command: (keyword, default==``echo``) the command that will do the counting; sometimes it&#39;s a good idea to replace this with ``/bin/true``</span>
<span class="sd">    :param catch: (keyword, default None) file where to catch output</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__commandcount__</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;nmax&quot;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;command&quot;</span><span class="p">,</span><span class="s">&quot;echo&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catch</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;catch&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Unprocessed CountedCommandGenerator args: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the next unix command string&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__commandcount__</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">nmax</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="n">thecount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__commandcount__</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__commandcount__</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span><span class="n">thecount</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">catch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="s">&quot; &gt;&gt; </span><span class="si">%s</span><span class="s"> 2&gt;&amp;1 &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">catch</span>
        <span class="k">return</span> <span class="n">command</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span>
</div>
<span class="k">def</span> <span class="nf">testCountedCommandGenerator</span><span class="p">():</span>
    <span class="n">ntasks</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">CountedCommandGenerator</span><span class="p">(</span><span class="n">nmax</span><span class="o">=</span><span class="n">ntasks</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">generator</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;echo&#39;</span><span class="p">,</span><span class="n">g</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">count</span><span class="o">==</span><span class="n">ntasks</span><span class="p">)</span>

<span class="n">pylauncherBarrierString</span> <span class="o">=</span> <span class="s">&quot;__barrier__&quot;</span>

<div class="viewcode-block" id="SleepCommandGenerator"><a class="viewcode-back" href="../testing.html#pylauncher.SleepCommandGenerator">[docs]</a><span class="k">class</span> <span class="nc">SleepCommandGenerator</span><span class="p">(</span><span class="n">CountedCommandGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generator of commandlines `echo 0 ; sleep trand&#39;, `echo 1 ; sleep trand&#39;</span>
<span class="sd">    where the sleep is a random amount.</span>

<span class="sd">    :param tmax: (keyword, default 5) maximum sleep time </span>
<span class="sd">    :param tmin: (keyword, default 1) minimum sleep time</span>
<span class="sd">    :param barrier: (keyword, default 0) if &gt;0, insert a barrier statement every that many lines</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;tmax&quot;</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;tmin&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;barrier&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_line_was_barrier</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">CountedCommandGenerator</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">catch</span><span class="o">=</span><span class="s">&quot;/dev/null&quot;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="o">==</span><span class="mi">0</span> \
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_line_was_barrier</span><span class="p">:</span>
            <span class="n">commandline</span> <span class="o">=</span> <span class="n">pylauncherBarrierString</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_line_was_barrier</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">commandline</span> <span class="o">=</span> <span class="n">CountedCommandGenerator</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">+</span>\
                <span class="s">&quot; ; sleep </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">RandomNumber</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span><span class="n">tmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_line_was_barrier</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">commandline</span>
</div>
<span class="k">def</span> <span class="nf">SingleSleepCommand</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;this should not be called in a loop: only for single test&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">SleepCommandGenerator</span><span class="p">(</span><span class="n">nmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">tmax</span><span class="o">=</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">testSleepCommandGenerator</span><span class="p">():</span>
    <span class="n">ntasks</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">tmax</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">SleepCommandGenerator</span><span class="p">(</span><span class="n">nmax</span><span class="o">=</span><span class="n">ntasks</span><span class="p">,</span><span class="n">tmax</span><span class="o">=</span><span class="n">tmax</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">generator</span><span class="p">:</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">split</span><span class="p">();</span> <span class="k">print</span> <span class="n">gs</span>
        <span class="c"># echo i 2&gt;&amp;1 &gt; /dev/null ; sleep t</span>
        <span class="c"># 0    1 2    3 4         5 6     7</span>
        <span class="k">assert</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="n">count</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">tmax</span> <span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">count</span><span class="o">==</span><span class="n">ntasks</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">testSleepCommandGeneratorBarrier</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;testSleepCommandGeneratorBarrier: test that we insert barriers&quot;&quot;&quot;</span>
    <span class="n">ntasks</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">tmax</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">barrier_interval</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">nbarrier</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span> <span class="n">ntasks</span><span class="o">/</span><span class="n">barrier_interval</span> <span class="p">)</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">SleepCommandGenerator</span><span class="p">(</span><span class="n">nmax</span><span class="o">=</span><span class="n">ntasks</span><span class="p">,</span><span class="n">tmax</span><span class="o">=</span><span class="n">tmax</span><span class="p">,</span><span class="n">barrier</span><span class="o">=</span><span class="n">barrier_interval</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count_barrier</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">generator</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">==</span><span class="n">pylauncherBarrierString</span><span class="p">:</span>
            <span class="n">count_barrier</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span> <span class="s">&quot;counted barrier </span><span class="si">%d</span><span class="s"> after </span><span class="si">%d</span><span class="s"> lines&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count_barrier</span><span class="p">,</span><span class="n">count</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">count_barrier</span><span class="o">&lt;=</span><span class="n">nbarrier</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">split</span><span class="p">();</span> <span class="k">print</span> <span class="n">gs</span>
        <span class="c"># echo i 2&gt;&amp;1 &gt; /dev/null ; sleep t</span>
        <span class="c"># 0    1 2    3 4         5 6     7</span>
        <span class="k">assert</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="n">count</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">tmax</span> <span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">print</span> <span class="s">&quot;tasks:&quot;</span><span class="p">,</span><span class="n">count</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">count</span><span class="o">==</span><span class="n">ntasks</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;barriers:&quot;</span><span class="p">,</span><span class="n">count_barrier</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">count_barrier</span><span class="o">==</span><span class="n">nbarrier</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Commandline</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;A Commandline is basically a dict containing at least the following members:</span>

<span class="sd">    * command : a unix commandline</span>
<span class="sd">    * cores : an integer core count</span>
<span class="sd">    * dependencies : dependency stuff.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;command&#39;</span><span class="p">:</span><span class="n">command</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;cores&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;cores&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;dependencies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;dependencies&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ind</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="s">&quot;command=&lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;, cores=</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&quot;command&quot;</span><span class="p">],</span><span class="bp">self</span><span class="p">[</span><span class="s">&quot;cores&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">r</span>

<div class="viewcode-block" id="CommandlineGenerator"><a class="viewcode-back" href="../implementation.html#pylauncher.CommandlineGenerator">[docs]</a><span class="k">class</span> <span class="nc">CommandlineGenerator</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;An iteratable class that generates a stream of ``Commandline`` objects.</span>

<span class="sd">    The behaviour of the generator depends on the ``nmax`` parameter:</span>

<span class="sd">    * nmax is None: exhaust the original list</span>
<span class="sd">    * nmax &gt; 0: keep popping until the count is reached; if the initial list is shorter, someone will have to fill it, which this class is not capable of</span>
<span class="sd">    * nmax == 0 : iterate indefinitely, wait for someone to call the ``finish`` method</span>

<span class="sd">    In the second and third scenario it can be the case that the list is empty.</span>
<span class="sd">    In that case, the generator will yield a COMMAND that is ``stall``.</span>

<span class="sd">    :param list: (keyword, default [] ) initial list of Commandline objects</span>
<span class="sd">    :param nax: (keyword, default None) see above for explanation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;list&quot;</span><span class="p">,[])</span> <span class="p">];</span> <span class="bp">self</span><span class="o">.</span><span class="n">njobs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;nmax&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nmax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Empty list requires nmax==0&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmax</span> <span class="o">=</span> <span class="n">nmax</span>
        <span class="n">debugs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;command&quot;</span><span class="p">,</span><span class="n">debugs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Unprocessed CommandlineGenerator args: </span><span class="si">%s</span><span class="s">&quot;</span> \
                                        <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span> <span class="o">=</span> <span class="bp">False</span>
<div class="viewcode-block" id="CommandlineGenerator.finish"><a class="viewcode-back" href="../implementation.html#pylauncher.CommandlineGenerator.finish">[docs]</a>    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tell the generator to stop after the commands list is depleted&quot;&quot;&quot;</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;declaring the commandline generator to be finished&quot;</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Cmd&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">njobs</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">)</span></div>
<div class="viewcode-block" id="CommandlineGenerator.abort"><a class="viewcode-back" href="../implementation.html#pylauncher.CommandlineGenerator.abort">[docs]</a>    <span class="k">def</span> <span class="nf">abort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop the generator, even if there are still elements in the commands list&quot;&quot;&quot;</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;gettingthe commandline generator to abort&quot;</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Cmd&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span> <span class="o">=</span> <span class="bp">True</span></div>
<div class="viewcode-block" id="CommandlineGenerator.next"><a class="viewcode-back" href="../implementation.html#pylauncher.CommandlineGenerator.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Produce the next Commandline object, or return an object telling that the</span>
<span class="sd">        generator is stalling or has stopped&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span><span class="p">:</span>
            <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;stopping the commandline generator&quot;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Cmd&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">elif</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmax</span><span class="o">!=</span><span class="mi">0</span> <span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmax</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">njobs</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">nmax</span> <span class="p">):</span>
            <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;time to stop commandline generator&quot;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Cmd&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;Popping command off list &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Cmd&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">njobs</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">return</span> <span class="n">j</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;stall&quot;</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">testGeneratorList</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;testGeneratorList: Generate commands from a list and count them&quot;&quot;&quot;</span>
    <span class="n">clist</span> <span class="o">=</span> <span class="p">[</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">)</span> <span class="p">]</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">CommandlineGenerator</span><span class="p">(</span><span class="nb">list</span><span class="o">=</span><span class="n">clist</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">g</span>
        <span class="k">if</span> <span class="n">count</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">clist</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">print</span> <span class="s">&quot;seen </span><span class="si">%d</span><span class="s"> commands&quot;</span> <span class="o">%</span> <span class="n">count</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">count</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">clist</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">testGeneratorListAdd</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;testGeneratorListAdd: generate commands from a list that gets expanded, use nmax&quot;&quot;&quot;</span>
    <span class="n">clist</span> <span class="o">=</span> <span class="p">[</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">)</span> <span class="p">]</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">CommandlineGenerator</span><span class="p">(</span><span class="nb">list</span><span class="o">=</span><span class="n">clist</span><span class="p">,</span><span class="n">nmax</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">clist</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">gen</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c"># this should be in an inherited class</span>
    <span class="k">print</span> <span class="s">&quot;seen </span><span class="si">%d</span><span class="s"> commands&quot;</span> <span class="o">%</span> <span class="n">count</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">count</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">clist</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">testGeneratorListFinish</span><span class="p">():</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">CommandlineGenerator</span><span class="p">(</span><span class="nb">list</span><span class="o">=</span><span class="p">[</span> 
            <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">)</span> <span class="p">],</span>
                               <span class="n">nmax</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nstop</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">gen</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">count</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">count</span><span class="o">==</span><span class="n">nstop</span><span class="p">:</span> <span class="n">gen</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&quot;seen </span><span class="si">%d</span><span class="s"> commands&quot;</span> <span class="o">%</span> <span class="n">count</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">count</span><span class="o">==</span><span class="n">nstop</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">testGeneratorStalling</span><span class="p">():</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">CommandlineGenerator</span><span class="p">(</span><span class="nb">list</span><span class="o">=</span><span class="p">[],</span><span class="n">nmax</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="k">print</span> <span class="n">rc</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">rc</span><span class="p">[</span><span class="s">&quot;command&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;stall&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ListCommandlineGenerator"><a class="viewcode-back" href="../testing.html#pylauncher.ListCommandlineGenerator">[docs]</a><span class="k">class</span> <span class="nc">ListCommandlineGenerator</span><span class="p">(</span><span class="n">CommandlineGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A generator from an explicit list of commandlines.</span>

<span class="sd">    * cores is 1 by default, other constants allowed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">cores</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;cores&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">commandlist</span> <span class="o">=</span> <span class="p">[</span> <span class="n">Commandline</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="n">cores</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;list&quot;</span><span class="p">,[])</span> <span class="p">]</span>
        <span class="n">CommandlineGenerator</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">list</span><span class="o">=</span><span class="n">commandlist</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FileCommandlineGenerator"><a class="viewcode-back" href="../implementation.html#pylauncher.FileCommandlineGenerator">[docs]</a><span class="k">class</span> <span class="nc">FileCommandlineGenerator</span><span class="p">(</span><span class="n">CommandlineGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A generator for commandline files:</span>
<span class="sd">    blank lines and lines starting with the comment character &#39;#&#39; are ignored</span>

<span class="sd">    * cores is 1 by default, other constants allowed.</span>
<span class="sd">    * cores==&#39;file&#39; means the file has &lt;&lt; count,command &gt;&gt; lines</span>
<span class="sd">    * if the file has core counts, but you don&#39;t specify the &#39;file&#39; value, they are ignored.</span>

<span class="sd">    :param filename: (required) name of the file with commandlines</span>
<span class="sd">    :param cores: (keyword, default 1) core count to be used for all commands</span>
<span class="sd">    :param dependencies: (keyword, default False) are there task dependencies?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">cores</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;cores&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;dependencies&quot;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span> <span class="n">commandlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^ *#&#39;</span><span class="p">,</span><span class="n">line</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^ *$&#39;</span><span class="p">,</span><span class="n">line</span><span class="p">):</span>
                <span class="k">continue</span> <span class="c"># skip blank and comment</span>
            <span class="k">if</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="n">split</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;No task#/dependency found &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="n">split</span><span class="p">)</span>
                <span class="n">c</span><span class="p">,</span><span class="n">td</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">split</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">split</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">cores</span><span class="p">;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">split</span>
                <span class="n">td</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cores</span><span class="o">==</span><span class="s">&quot;file&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;[0-9]+&quot;</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">LauncherException</span> \
                        <span class="p">(</span><span class="s">&quot;First field &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt; is not a core count; line:</span><span class="se">\n</span><span class="s">&lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">line</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">cores</span>
            <span class="n">commandlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Commandline</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">dependencies</span><span class="o">=</span><span class="n">td</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">CommandlineGenerator</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">list</span><span class="o">=</span><span class="n">commandlist</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">testFileCommandLineGenerator</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;testFileCommandLineGenerator: create a file and make sure</span>
<span class="sd">    we get a commandline for each file line&quot;&quot;&quot;</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">RandomFile</span><span class="p">()</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="s">&quot;b&quot;</span><span class="p">,</span><span class="s">&quot;c&quot;</span><span class="p">,</span><span class="s">&quot;d&quot;</span><span class="p">]:</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;command&quot;</span><span class="p">];</span> <span class="n">c</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;cores&quot;</span><span class="p">]</span>
    <span class="k">print</span> <span class="n">r</span><span class="p">;</span> <span class="k">assert</span><span class="p">(</span><span class="n">r</span><span class="o">==</span><span class="s">&quot;a&quot;</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">==</span><span class="s">&quot;1&quot;</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;command&quot;</span><span class="p">];</span> <span class="n">c</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;cores&quot;</span><span class="p">]</span>
    <span class="k">print</span> <span class="n">r</span><span class="p">;</span> <span class="k">assert</span><span class="p">(</span><span class="n">r</span><span class="o">==</span><span class="s">&quot;b&quot;</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">==</span><span class="s">&quot;1&quot;</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;command&quot;</span><span class="p">];</span> <span class="n">c</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;cores&quot;</span><span class="p">]</span>
    <span class="k">print</span> <span class="n">r</span><span class="p">;</span> <span class="k">assert</span><span class="p">(</span><span class="n">r</span><span class="o">==</span><span class="s">&quot;c&quot;</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">==</span><span class="s">&quot;1&quot;</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;command&quot;</span><span class="p">];</span> <span class="n">c</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;cores&quot;</span><span class="p">]</span>
    <span class="k">print</span> <span class="n">r</span><span class="p">;</span> <span class="k">assert</span><span class="p">(</span><span class="n">r</span><span class="o">==</span><span class="s">&quot;d&quot;</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">==</span><span class="s">&quot;1&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/rm -f </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">testCoreFileCommandLineGenerator</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;testCoreFileCommandLineGenerator: create a file and make sure</span>
<span class="sd">    we get a commandline for each file line, including core count&quot;&quot;&quot;</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">RandomFile</span><span class="p">()</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;1,a&quot;</span><span class="p">,</span><span class="s">&quot;3,b&quot;</span><span class="p">,</span><span class="s">&quot;2,c&quot;</span><span class="p">,</span><span class="s">&quot;5,d&quot;</span><span class="p">]:</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="s">&quot;file&quot;</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;command&quot;</span><span class="p">];</span> <span class="n">c</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;cores&quot;</span><span class="p">]</span>
    <span class="k">print</span> <span class="s">&quot;&lt;&lt;r=</span><span class="si">%s</span><span class="s">&gt;&gt;,&lt;&lt;c=</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">));</span> <span class="k">assert</span><span class="p">(</span><span class="n">r</span><span class="o">==</span><span class="s">&quot;a&quot;</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">==</span><span class="s">&quot;1&quot;</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;command&quot;</span><span class="p">];</span> <span class="n">c</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;cores&quot;</span><span class="p">]</span>
    <span class="k">print</span> <span class="s">&quot;&lt;&lt;r=</span><span class="si">%s</span><span class="s">&gt;&gt;,&lt;&lt;c=</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">));</span> <span class="k">assert</span><span class="p">(</span><span class="n">r</span><span class="o">==</span><span class="s">&quot;b&quot;</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">==</span><span class="s">&quot;3&quot;</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;command&quot;</span><span class="p">];</span> <span class="n">c</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;cores&quot;</span><span class="p">]</span>
    <span class="k">print</span> <span class="s">&quot;&lt;&lt;r=</span><span class="si">%s</span><span class="s">&gt;&gt;,&lt;&lt;c=</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">));</span> <span class="k">assert</span><span class="p">(</span><span class="n">r</span><span class="o">==</span><span class="s">&quot;c&quot;</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">==</span><span class="s">&quot;2&quot;</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;command&quot;</span><span class="p">];</span> <span class="n">c</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;cores&quot;</span><span class="p">]</span>
    <span class="k">print</span> <span class="s">&quot;&lt;&lt;r=</span><span class="si">%s</span><span class="s">&gt;&gt;,&lt;&lt;c=</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">));</span> <span class="k">assert</span><span class="p">(</span><span class="n">r</span><span class="o">==</span><span class="s">&quot;d&quot;</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">==</span><span class="s">&quot;5&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/rm -f </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

<div class="viewcode-block" id="DynamicCommandlineGenerator"><a class="viewcode-back" href="../implementation.html#pylauncher.DynamicCommandlineGenerator">[docs]</a><span class="k">class</span> <span class="nc">DynamicCommandlineGenerator</span><span class="p">(</span><span class="n">CommandlineGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CommandlineGenerator with an extra method:</span>

<span class="sd">    ``append``: add a Commandline object to the list</span>

<span class="sd">    The &#39;nmax=0&#39; parameter value makes the generator keep expecting new stuff.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;nmax&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Dynamic launcher can not have nmax specification&quot;</span><span class="p">)</span>
        <span class="n">CommandlineGenerator</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nmax</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<div class="viewcode-block" id="DynamicCommandlineGenerator.append"><a class="viewcode-back" href="../implementation.html#pylauncher.DynamicCommandlineGenerator.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">command</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append a unix command to the internal structure of the generator&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,(</span><span class="n">Commandline</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;append argument needs to be Commandline object&quot;</span><span class="p">)</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;appending to command list &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">command</span><span class="p">),</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Cmd&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</div></div>
<span class="k">def</span> <span class="nf">testDynamicGeneratorStalling</span><span class="p">():</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">DynamicCommandlineGenerator</span><span class="p">(</span><span class="nb">list</span><span class="o">=</span><span class="p">[])</span>
    <span class="c"># generator is empty</span>
    <span class="k">print</span> <span class="s">&quot;len:&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;command&quot;</span><span class="p">];</span> <span class="n">c</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;cores&quot;</span><span class="p">]</span>
    <span class="k">print</span> <span class="n">r</span><span class="p">,</span><span class="n">c</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">r</span><span class="o">==</span><span class="s">&quot;stall&quot;</span><span class="p">)</span>
    <span class="c">#</span>
    <span class="n">generator</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">)</span> <span class="p">)</span>
    <span class="c"># generator has one item</span>
    <span class="k">print</span> <span class="s">&quot;len:&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;command&quot;</span><span class="p">];</span> <span class="n">c</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;cores&quot;</span><span class="p">]</span>
    <span class="k">print</span> <span class="n">r</span><span class="p">,</span><span class="n">c</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">r</span><span class="o">==</span><span class="s">&quot;foo&quot;</span><span class="p">)</span>
    <span class="c"># generator is empty again</span>
    <span class="k">print</span> <span class="s">&quot;len:&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;command&quot;</span><span class="p">];</span> <span class="n">c</span> <span class="o">=</span> <span class="n">rc</span><span class="p">[</span><span class="s">&quot;cores&quot;</span><span class="p">]</span>
    <span class="k">print</span> <span class="n">r</span><span class="p">,</span><span class="n">c</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">r</span><span class="o">==</span><span class="s">&quot;stall&quot;</span><span class="p">)</span>
    <span class="n">generator</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="c"># generator is empty and finished so it raises StopIteration</span>
    <span class="k">try</span><span class="p">:</span> 
        <span class="n">rc</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

<div class="viewcode-block" id="DirectoryCommandlineGenerator"><a class="viewcode-back" href="../implementation.html#pylauncher.DirectoryCommandlineGenerator">[docs]</a><span class="k">class</span> <span class="nc">DirectoryCommandlineGenerator</span><span class="p">(</span><span class="n">DynamicCommandlineGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CommandlineGenerator object based on finding files in a directory.</span>

<span class="sd">    :param command_directory: (directory name, required) directory where commandlines are found; unlike launcher job work directories, this can be reused.</span>
<span class="sd">    :param commandfile_root: (string, required) only files that start with this, followed by a dash, are inspected for commands. A file can contain more than one command.</span>
<span class="sd">    :param cores: (keyword, optional, default 1) core count for the commandlines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">command_directory</span><span class="p">,</span><span class="n">commandfile_root</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command_directory</span> <span class="o">=</span> <span class="n">command_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commandfile_root</span> <span class="o">=</span> <span class="n">commandfile_root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish_name</span> <span class="o">=</span> <span class="n">commandfile_root</span><span class="o">+</span><span class="s">&quot;-finished&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;cores&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_jobs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">DynamicCommandlineGenerator</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<div class="viewcode-block" id="DirectoryCommandlineGenerator.next"><a class="viewcode-back" href="../implementation.html#pylauncher.DirectoryCommandlineGenerator.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; List the directory and iterate over the commandfiles:</span>

<span class="sd">        * ignore any open files, which are presumably still being written</span>
<span class="sd">        * if they are marked as scheduled, ignore</span>
<span class="sd">        * if there is a file ``finish-nnn``, mark job nnn as finished</span>
<span class="sd">        * if they are not yet scheduled, call ``append`` with a ``Commandline`` object</span>

<span class="sd">        If the finish name is present, and all scheduled jobs are finished, finish the generator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dircontents</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command_directory</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;contents&quot;</span><span class="p">,</span><span class="n">dircontents</span>
        <span class="c">#</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dircontents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commandfile_root</span><span class="p">,</span><span class="n">f</span><span class="p">):</span>
                <span class="n">long_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command_directory</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span> <span class="c"># if the file is still being written, we ignore it</span>
                    <span class="n">testopen</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">long_filename</span><span class="p">,</span><span class="s">&quot;a+&quot;</span><span class="p">)</span>
                    <span class="n">testopen</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;file still open&quot;</span><span class="p">,</span><span class="n">f</span>
                    <span class="k">continue</span>
                <span class="n">jobnumber</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">jobnumber</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_jobs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jobnumber</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s">&quot;scheduling job&quot;</span><span class="p">,</span><span class="n">jobnumber</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">long_filename</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">commandfile</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">commandfile</span><span class="p">:</span>
                            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Commandline</span><span class="p">(</span> <span class="n">l</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="p">)</span> <span class="p">)</span>
        <span class="c">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finish_name</span> <span class="ow">in</span> <span class="n">dircontents</span><span class="p">:</span>
            <span class="n">allfinished</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">allfinished</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">CommandlineGenerator</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div></div>
<span class="k">class</span> <span class="nc">testDirectoryCommandlineGenerators</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirname</span> <span class="o">=</span> <span class="n">MakeRandomDir</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;running Directory Generator in &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileroot</span> <span class="o">=</span> <span class="n">RandomFile</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;MECS&quot;</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsleep</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="c"># create the command files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nums</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span> <span class="p">]</span>
    <span class="k">def</span> <span class="nf">makefiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nums</span><span class="p">:</span>
            <span class="n">commandfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileroot</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))),</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">commandfinish</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">,</span><span class="s">&quot;finished-</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
            <span class="n">wait</span> <span class="o">=</span> <span class="n">RandomNumber</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsleep</span><span class="p">)</span>
            <span class="n">commandfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;echo job </span><span class="si">%s</span><span class="s"> ; sleep </span><span class="si">%d</span><span class="s">; touch </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">wait</span><span class="p">,</span><span class="n">commandfinish</span><span class="p">))</span>
            <span class="n">commandfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c"># create the finish file which says this is all there is</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s">&#39;touch&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">-finished&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileroot</span><span class="p">)</span> <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">)</span> 
                       <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">,</span><span class="n">f</span><span class="p">))</span> <span class="p">]</span>
    <span class="k">def</span> <span class="nf">makejob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">gen</span><span class="p">):</span>
        <span class="n">debug</span><span class="o">=</span><span class="s">&quot;job+command+task&quot;</span><span class="p">;</span> <span class="n">workdir</span> <span class="o">=</span> <span class="n">NoRandomDir</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">LauncherJob</span><span class="p">(</span> 
            <span class="n">hostpool</span><span class="o">=</span><span class="n">HostPool</span><span class="p">(</span> <span class="n">hostlist</span><span class="o">=</span><span class="n">HostListByName</span><span class="p">(),</span>
                <span class="n">commandexecutor</span><span class="o">=</span><span class="n">SSHExecutor</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span> <span class="p">),</span>
            <span class="n">taskgenerator</span><span class="o">=</span><span class="n">TaskGenerator</span><span class="p">(</span> <span class="n">gen</span><span class="p">,</span>
                <span class="n">completion</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">FileCompletion</span><span class="p">(</span> <span class="n">taskid</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                                         <span class="n">stamproot</span><span class="o">=</span><span class="s">&quot;expire&quot;</span><span class="p">,</span><span class="n">stampdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">),</span>
                <span class="n">debug</span><span class="o">=</span><span class="n">debug</span> <span class="p">)</span>
            <span class="p">)</span>
    <span class="k">def</span> <span class="nf">testDirectoryCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testDirectoryCommandlineGenerator: test finding commands in directory&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">makefiles</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;files:&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nums</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># now process the files</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">DirectoryCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fileroot</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ig</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">gen</span> <span class="p">):</span>
            <span class="k">print</span> <span class="n">ig</span><span class="p">,</span><span class="n">g</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">ig</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nums</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testDirectoryCommandlineGeneratorJob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testDirectoryCommandlineGeneratorJob: test finding commands in directory&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">makefiles</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;files:&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nums</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># now process the files</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">DirectoryCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fileroot</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makejob</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">tick</span><span class="p">();</span> <span class="k">print</span> <span class="n">r</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">==</span><span class="s">&quot;finished&quot;</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">starttime</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">nsleep</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nums</span><span class="p">)</span><span class="o">*</span><span class="n">j</span><span class="o">.</span><span class="n">delay</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;This is taking too long&quot;</span><span class="p">;</span> <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testDirectoryCommandlineGeneratorFromZero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testDirectoryCommandlineGeneratorFromZero: start with empty directory&quot;&quot;&quot;</span>
        <span class="c"># first we create the generator on an empty directory</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">DirectoryCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fileroot</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s">&quot;command&quot;</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;stall&quot;</span><span class="p">)</span>
        <span class="c"># create the command files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">makefiles</span><span class="p">()</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nums</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># now process the files</span>
        <span class="k">for</span> <span class="n">ig</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">gen</span> <span class="p">):</span>
            <span class="k">print</span> <span class="n">ig</span><span class="p">,</span><span class="n">g</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">ig</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nums</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testDirectoryCommandlineGeneratorJobFromZero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testDirectoryCommandlineGeneratorJob: test finding commands in directory&quot;&quot;&quot;</span>
        <span class="c"># first we create the generator on an empty directory</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">DirectoryCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fileroot</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makejob</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">tick</span><span class="p">();</span> <span class="k">print</span> <span class="n">r</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">r</span><span class="o">==</span><span class="s">&quot;stalling&quot;</span><span class="p">)</span>
        <span class="c"># now actually make the files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">makefiles</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;files:&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nums</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># now process the files</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">tick</span><span class="p">();</span> <span class="k">print</span> <span class="n">r</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">==</span><span class="s">&quot;finished&quot;</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">starttime</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">nsleep</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nums</span><span class="p">)</span><span class="o">*</span><span class="n">j</span><span class="o">.</span><span class="n">delay</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;This is taking too long&quot;</span><span class="p">;</span> <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

<div class="viewcode-block" id="MakeRandomCommandFile"><a class="viewcode-back" href="../testing.html#pylauncher.MakeRandomCommandFile">[docs]</a><span class="k">def</span> <span class="nf">MakeRandomCommandFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">ncommand</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make file with commandlines and occasional comments and blanks.</span>

<span class="sd">    :param cores: (keyword, default=1) corecount, if this is 1 we put nothing in the file, larger values and \&quot;file\&quot; (for random) go into the file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cores</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;cores&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;generator&quot;</span><span class="p">,</span><span class="n">CountedCommandGenerator</span><span class="p">(</span><span class="n">nmax</span><span class="o">=</span><span class="n">ncommand</span><span class="p">,</span><span class="n">catch</span><span class="o">=</span><span class="s">&quot;/dev/null&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;generator&quot;</span><span class="p">,</span><span class="n">CountedCommandGenerator</span><span class="p">(</span><span class="n">nmax</span><span class="o">=</span><span class="n">ncommand</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Unprocessed args: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="n">commandlines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncommand</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">5</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">commandlines</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;# arbitrary comment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">7</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">commandlines</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cores</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">,</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cores</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
        <span class="n">commandlines</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">c</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">)</span>
    <span class="n">commandlines</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="MakeRandomSleepFile"><a class="viewcode-back" href="../testing.html#pylauncher.MakeRandomSleepFile">[docs]</a><span class="k">def</span> <span class="nf">MakeRandomSleepFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">ncommand</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;make file with sleep commandlines and occasional comments and blanks&quot;&quot;&quot;</span>
    <span class="n">tmax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;tmax&quot;</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">MakeRandomCommandFile</span>\
        <span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">ncommand</span><span class="p">,</span><span class="n">generator</span><span class="o">=</span><span class="n">SleepCommandGenerator</span><span class="p">(</span><span class="n">nmax</span><span class="o">=</span><span class="n">ncommand</span><span class="p">,</span><span class="n">tmax</span><span class="o">=</span><span class="n">tmax</span><span class="p">),</span>
         <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<span class="k">class</span> <span class="nc">TestCommandlineGenerators</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;make a commandlines file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="s">&quot;unittestlines&quot;</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span> <span class="o">=</span> <span class="mi">60</span>
        <span class="n">MakeRandomCommandFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;rm -f </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testFileCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testFileCommandlineGenerator: exhaust the lines of a file&quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">lc</span> <span class="ow">in</span> <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">print</span> <span class="n">lc</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">lc</span><span class="p">[</span><span class="s">&quot;command&quot;</span><span class="p">]</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span> <span class="s">&quot;counted: </span><span class="si">%d</span><span class="s">, should be </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">count</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testDynamicCommandlineGeneratorInf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testDynamicCommandlineGeneratorInf: generate commands until dynamic finish&quot;&quot;&quot;</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="mi">70</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">nmax</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">)</span>
        <span class="n">clist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">coms</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coms</span><span class="p">:</span>
                <span class="n">clist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">more_commands</span> <span class="o">=</span> <span class="n">SleepCommandGenerator</span><span class="p">()</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">DynamicCommandlineGenerator</span><span class="p">(</span> <span class="nb">list</span><span class="o">=</span><span class="n">clist</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span><span class="n">command</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">generator</span><span class="p">):</span>
            <span class="k">print</span> <span class="n">count</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Commandline</span><span class="p">(</span><span class="n">more_commands</span><span class="o">.</span><span class="n">next</span><span class="p">())</span> <span class="p">)</span> 
            <span class="k">if</span> <span class="n">count</span><span class="o">==</span><span class="n">nmax</span><span class="p">:</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
                <span class="c">#generator.finish()</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">count</span><span class="o">==</span><span class="n">nmax</span><span class="p">)</span>

<div class="viewcode-block" id="Completion"><a class="viewcode-back" href="../implementation.html#pylauncher.Completion">[docs]</a><span class="k">class</span> <span class="nc">Completion</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Define a completion object for a task. </span>

<span class="sd">    The base class doesn&#39;t do a lot: it immediately returns true on the </span>
<span class="sd">    completion test.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workdir</span> <span class="o">=</span> <span class="s">&quot;.&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">taskid</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskid</span> <span class="o">=</span> <span class="n">taskid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stampdir</span> <span class="o">=</span> <span class="s">&quot;.&quot;</span>
    <span class="k">def</span> <span class="nf">set_workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">workdir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">workdir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot;/&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span>
        <span class="c"># create stampdir. maybe this should be in the attach method?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
<div class="viewcode-block" id="Completion.attach"><a class="viewcode-back" href="../implementation.html#pylauncher.Completion.attach">[docs]</a>    <span class="k">def</span> <span class="nf">attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">txt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attach a completion to a command, giving a new command&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">txt</span></div>
<div class="viewcode-block" id="Completion.test"><a class="viewcode-back" href="../implementation.html#pylauncher.Completion.test">[docs]</a>    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test whether the task has completed&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">True</span>
</div></div>
<div class="viewcode-block" id="FileCompletion"><a class="viewcode-back" href="../implementation.html#pylauncher.FileCompletion">[docs]</a><span class="k">class</span> <span class="nc">FileCompletion</span><span class="p">(</span><span class="n">Completion</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;FileCompletion is the most common type of completion. It appends</span>
<span class="sd">    to a command the creation of a zero size file with a unique name.</span>
<span class="sd">    The completion test then tests for the existence of that file.</span>

<span class="sd">    :param taskid: (keyword, required) this has to be unique. Unfortunately we can not test for that.</span>
<span class="sd">    :param stampdir: (keyword, optional, default is self.stampdir, which is &quot;.&quot;) directory where the stampfile is left</span>
<span class="sd">    :param stamproot: (keyword, optional, default is &quot;expire&quot;) root of the stampfile name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stamproot</span> <span class="o">=</span> <span class="s">&quot;expire&quot;</span>
    <span class="n">stampdir</span> <span class="o">=</span> <span class="s">&quot;.&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">taskid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;taskid&quot;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">taskid</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Need an explicit task ID&quot;</span><span class="p">)</span>
        <span class="n">Completion</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">taskid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;stampdir&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stampdir</span><span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stamproot</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;stamproot&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stamproot</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Unprocessed FileCompletion args: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
<div class="viewcode-block" id="FileCompletion.stampname"><a class="viewcode-back" href="../implementation.html#pylauncher.FileCompletion.stampname">[docs]</a>    <span class="k">def</span> <span class="nf">stampname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal function that gives the name of the stamp file,</span>
<span class="sd">        including directory path&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stamproot</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskid</span><span class="p">))</span></div>
<div class="viewcode-block" id="FileCompletion.attach"><a class="viewcode-back" href="../implementation.html#pylauncher.FileCompletion.attach">[docs]</a>    <span class="k">def</span> <span class="nf">attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">txt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append a &#39;touch&#39; command to the txt argument&quot;&quot;&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;mkdir -p </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^[ </span><span class="se">\t</span><span class="s">]*$&#39;</span><span class="p">,</span><span class="n">txt</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;touch </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> ; touch </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">txt</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="p">())</span></div>
<div class="viewcode-block" id="FileCompletion.test"><a class="viewcode-back" href="../implementation.html#pylauncher.FileCompletion.test">[docs]</a>    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test for the existence of the stamp file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="p">())</span></div>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;rm -f </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="Task"><a class="viewcode-back" href="../implementation.html#pylauncher.Task">[docs]</a><span class="k">class</span> <span class="nc">Task</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;A Task is an abstract object associated with a commandline</span>

<span class="sd">    :param command: (required) Commandline object; note that this contains the core count</span>
<span class="sd">    :param completion: (keyword, optional) Completion object; if unspecified the trivial completion is used.</span>
<span class="sd">    :param taskid: (keyword) identifying number of this task; has to be unique in a job, also has to be equal to the taskid of the completion</span>
<span class="sd">    :param debug: (keyword, optional) string of debug keywords</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span><span class="p">[</span><span class="s">&quot;command&quot;</span><span class="p">]</span>
        <span class="c"># make a default completion if needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;completion&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;taskid&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">completion</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="n">Completion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskid</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskid</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">taskid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Incompatible taskids&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">command</span><span class="p">[</span><span class="s">&quot;cores&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;task&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debugs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Unprocessed args: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_started</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;created task &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Task&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="bp">None</span>
<div class="viewcode-block" id="Task.start_on_nodes"><a class="viewcode-back" href="../implementation.html#pylauncher.Task.start_on_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">start_on_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start the task.</span>

<span class="sd">        :param pool: HostLocator object (keyword, required) : this describes the nodes on which to start the task</span>
<span class="sd">        :param commandexecutor: (keyword, optional) prefixer routine, by default the commandexecutor of the pool is used</span>

<span class="sd">        This sets ``self.startime`` to right before the execution begins. We do not keep track</span>
<span class="sd">        of the endtime, but instead set ``self.runningtime`` in the ``hasCompleted`` routine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;pool&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">LocalHostPool</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debugs</span>
                                      <span class="p">)</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">,(</span><span class="n">Node</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Can not start size=</span><span class="si">%d</span><span class="s"> on sing Node&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">OneNodePool</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debugs</span> <span class="p">)</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">,(</span><span class="n">HostLocator</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Invalid locator object&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Unprocessed Task.start_on_nodes args: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="c"># wrap with stamp detector</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_with_completion</span><span class="p">()</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span>
            <span class="s">&quot;starting task </span><span class="si">%d</span><span class="s"> of size </span><span class="si">%d</span><span class="s"> on &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;</span><span class="se">\n</span><span class="s">in cwd=&lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;</span><span class="se">\n</span><span class="s">cmd=&lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskid</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">),</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="n">wrapped</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Task&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">commandexecutor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">commandexecutor</span>
        <span class="n">commandexecutor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span><span class="n">pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_started</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;.. started </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskid</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Task&quot;</span><span class="p">)</span></div>
<div class="viewcode-block" id="Task.line_with_completion"><a class="viewcode-back" href="../implementation.html#pylauncher.Task.line_with_completion">[docs]</a>    <span class="k">def</span> <span class="nf">line_with_completion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the task&#39;s commandline with completion attached&quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;PYL_ID&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskid</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">isRunning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_started</span>
<div class="viewcode-block" id="Task.hasCompleted"><a class="viewcode-back" href="../implementation.html#pylauncher.Task.hasCompleted">[docs]</a>    <span class="k">def</span> <span class="nf">hasCompleted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute the completion test of this Task&quot;&quot;&quot;</span>
        <span class="n">completed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_started</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">test</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">completed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runningtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">starttime</span>
            <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;Task </span><span class="si">%d</span><span class="s"> has completed in </span><span class="si">%5.3f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskid</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">runningtime</span><span class="p">),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Task&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">completed</span></div>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Task </span><span class="si">%d</span><span class="s">, commandline: [</span><span class="si">%s</span><span class="s">], pool size </span><span class="si">%d</span><span class="s">&quot;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taskid</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>
</div>
<span class="k">class</span> <span class="nc">testCompletions</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># get rid of old workdirs</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">Executor</span><span class="o">.</span><span class="n">default_workdir</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;ls -l </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tmpdir</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;rm -f </span><span class="si">%s</span><span class="s">/*&quot;</span> <span class="o">%</span> <span class="n">tmpdir</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">testTrivialCompletion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;/bin/true&quot;</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">hasCompleted</span><span class="p">())</span>
        <span class="n">task</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">()</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">hasCompleted</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">testCurDirCompletion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;rm -f expirefoo5&quot;</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;/bin/true&quot;</span><span class="p">),</span><span class="n">taskid</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
              <span class="n">completion</span><span class="o">=</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">stamproot</span><span class="o">=</span><span class="s">&quot;expirefoo&quot;</span><span class="p">,</span><span class="n">stampdir</span><span class="o">=</span><span class="s">&quot;.&quot;</span><span class="p">,))</span>
        <span class="k">print</span> <span class="s">&quot;expected stamp:&quot;</span><span class="p">,</span><span class="n">task</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">stampname</span><span class="p">()</span>
        <span class="n">task</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s">&quot;./expirefoo5&quot;</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;rm -f expirefoo5&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testSubDirCompletion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;rm -rf launchtest&quot;</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;/bin/true&quot;</span><span class="p">),</span><span class="n">taskid</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
            <span class="n">completion</span><span class="o">=</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                                 <span class="n">stamproot</span><span class="o">=</span><span class="s">&quot;expirefoo&quot;</span><span class="p">,</span><span class="n">stampdir</span><span class="o">=</span><span class="s">&quot;launchtest&quot;</span><span class="p">,))</span>
        <span class="n">task</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s">&quot;launchtest/expirefoo7&quot;</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;rm -rf launchtest&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RandomSleepTask"><a class="viewcode-back" href="../testing.html#pylauncher.RandomSleepTask">[docs]</a><span class="k">class</span> <span class="nc">RandomSleepTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a task that sleeps for a random amount of time.</span>
<span class="sd">    This is for use in many many unit tests.</span>

<span class="sd">    :param taskid: unique identifier (keyword, required)</span>
<span class="sd">    :param t: maximum running time (keyword, optional; default=10)</span>
<span class="sd">    :param tmin: minimum running time (keyword, optional; default=1)</span>
<span class="sd">    :param completion: Completion object (keyword, optional; if you leave this unspecified, the next two parameters become relevant</span>
<span class="sd">    :param stampdir: name of the directory where to leave the stamp file (optional, default=current dir)</span>
<span class="sd">    :param stamproot: filename stemp for the stamp file (optional, default=&quot;sleepexpire&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stampdir</span> <span class="o">=</span> <span class="s">&quot;.&quot;</span>
    <span class="n">stamproot</span> <span class="o">=</span> <span class="s">&quot;sleepexpire&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">taskid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;taskid&quot;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">taskid</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Need an explicit sleep task ID&quot;</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;t&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span> <span class="n">tmin</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;tmin&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">stamproot</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;stamproot&quot;</span><span class="p">,</span><span class="n">RandomSleepTask</span><span class="o">.</span><span class="n">stamproot</span><span class="p">)</span>
        <span class="n">stampdir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;stampdir&quot;</span><span class="p">,</span><span class="n">RandomSleepTask</span><span class="o">.</span><span class="n">stampdir</span><span class="p">)</span>
        <span class="n">completion</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;completion&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">completion</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">completion</span> <span class="o">=</span> <span class="n">FileCompletion</span>\
                <span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">taskid</span><span class="p">,</span><span class="n">stamproot</span><span class="o">=</span><span class="n">stamproot</span><span class="p">,</span><span class="n">stampdir</span><span class="o">=</span><span class="n">stampdir</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">SleepCommandGenerator</span><span class="p">(</span><span class="n">nmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">tmax</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">tmin</span><span class="o">=</span><span class="n">tmin</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">Task</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Commandline</span><span class="p">(</span><span class="n">command</span><span class="p">),</span><span class="n">taskid</span><span class="o">=</span><span class="n">taskid</span><span class="p">,</span><span class="n">completion</span><span class="o">=</span><span class="n">completion</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        </div>
<span class="k">class</span> <span class="nc">testTasksOnSingleNode</span><span class="p">():</span>
    <span class="n">stampname</span> <span class="o">=</span> <span class="s">&quot;pylauncher_tmp_singlenode_tasktest&quot;</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s">&quot;rm -f </span><span class="si">%s</span><span class="s">*&quot;</span> <span class="o">%</span> <span class="n">RandomSleepTask</span><span class="o">.</span><span class="n">stamproot</span> <span class="p">)</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">Executor</span><span class="o">.</span><span class="n">default_workdir</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">LocalHostPool</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="c">#OneNodePool( Node(HostName()) )</span>
    <span class="k">def</span> <span class="nf">testLeaveStampOnOneNode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testLeaveStampOnOneNode: leave a stamp on a one-node pool&quot;&quot;&quot;</span>
        <span class="n">nsleep</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">RandomSleepTask</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">nsleep</span><span class="p">,</span>
                            <span class="n">completion</span><span class="o">=</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                      <span class="n">stamproot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="p">),</span>
                            <span class="n">debug</span><span class="o">=</span><span class="s">&quot;exec+task+ssh&quot;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;starting task:&quot;</span><span class="p">,</span><span class="n">t</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nsleep</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dircontent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">stampdir</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;looking for stamp &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt; in &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="p">,</span><span class="n">t</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">stampdir</span><span class="p">)</span>
        <span class="k">print</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dircontent</span><span class="p">)</span>
        <span class="n">stamps</span> <span class="o">=</span> <span class="p">[</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dircontent</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">print</span> <span class="s">&quot;stamps:&quot;</span><span class="p">,</span><span class="n">stamps</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stamps</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">testTasks</span><span class="p">():</span>
    <span class="n">stampname</span> <span class="o">=</span> <span class="s">&quot;pylauncher_tmp_tasktest&quot;</span>
    <span class="n">stampdir</span> <span class="o">=</span> <span class="s">&quot;pylauncher_tmpdir_tasktestdir&quot;</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s">&quot;rm -f </span><span class="si">%s</span><span class="s">*&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">stampname</span> <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s">&quot;rm -f </span><span class="si">%s</span><span class="s">*&quot;</span> <span class="o">%</span> <span class="n">FileCompletion</span><span class="o">.</span><span class="n">stamproot</span> <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s">&quot;rm -f </span><span class="si">%s</span><span class="s">*&quot;</span> <span class="o">%</span> <span class="n">RandomSleepTask</span><span class="o">.</span><span class="n">stamproot</span> <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s">&quot;rm -rf </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">stampdir</span> <span class="p">)</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">Executor</span><span class="o">.</span><span class="n">default_workdir</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntasks</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">LocalHostPool</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ntasks</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testImmediateIssue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testImmediateIssue: make sure tasks are run in the background&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntasks</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">RandomSleepTask</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">stamproot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testLeaveStamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testLeaveStamp: make sure tasks leave a stampfile&quot;&quot;&quot;</span>
        <span class="n">nsleep</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntasks</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">RandomSleepTask</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">nsleep</span><span class="p">,</span>
                                <span class="n">completion</span><span class="o">=</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                                                          <span class="n">stamproot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="p">))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">stampdir</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">stampdir</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nsleep</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dircontent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">stampdir</span><span class="p">)</span>
        <span class="n">stamps</span> <span class="o">=</span> <span class="p">[</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dircontent</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">print</span> <span class="s">&quot;stamps:&quot;</span><span class="p">,</span><span class="n">stamps</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stamps</span><span class="p">)</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">ntasks</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testCompleteOnStamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testCompleteOnStamp: make sure stampfiles are detected&quot;&quot;&quot;</span>
        <span class="n">stamproot</span> <span class="o">=</span> <span class="s">&quot;expiresomething&quot;</span>
        <span class="n">nsleep</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntasks</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">RandomSleepTask</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">nsleep</span><span class="p">,</span>
                                <span class="n">completion</span><span class="o">=</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">stamproot</span><span class="o">=</span><span class="n">stamproot</span><span class="p">,</span><span class="n">taskid</span><span class="o">=</span><span class="n">i</span><span class="p">))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">finished</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntasks</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">reduce</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">y</span><span class="p">,</span>
                       <span class="p">[</span> <span class="n">t</span><span class="o">.</span><span class="n">hasCompleted</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="p">]</span> <span class="p">):</span> <span class="k">break</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="o">&gt;</span><span class="n">nsleep</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;this is taking too long&quot;</span>
                <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">dircontent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;dir content:&quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dircontent</span><span class="p">)</span>
        <span class="n">stamps</span> <span class="o">=</span> <span class="p">[</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dircontent</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">stamproot</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">print</span> <span class="s">&quot;stamps:&quot;</span><span class="p">,</span><span class="n">stamps</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stamps</span><span class="p">)</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">ntasks</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testCompleteOnDefaultStamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testCompleteOnDefaultStamp: make sure stampfiles are detected in default setup&quot;&quot;&quot;</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">nsleep</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntasks</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">RandomSleepTask</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">nsleep</span><span class="p">,</span>
                       <span class="n">completion</span><span class="o">=</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">stampdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stampdir</span><span class="p">,</span><span class="n">taskid</span><span class="o">=</span><span class="n">i</span><span class="p">))</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">stamproot</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">stamproot</span>
        <span class="k">print</span> <span class="s">&quot;stamps based on:&quot;</span><span class="p">,</span><span class="n">stamproot</span>
        <span class="n">finished</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntasks</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;tick&quot;</span>
            <span class="k">if</span> <span class="nb">reduce</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">y</span><span class="p">,</span>
                       <span class="p">[</span> <span class="n">t</span><span class="o">.</span><span class="n">hasCompleted</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tasks</span> <span class="p">]</span> <span class="p">):</span> <span class="k">break</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="o">&gt;</span><span class="n">nsleep</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;this is taking too long&quot;</span>
                <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dircontent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stampdir</span><span class="p">)</span>
        <span class="n">stamps</span> <span class="o">=</span> <span class="p">[</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dircontent</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">stamproot</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">print</span> <span class="s">&quot;stamps:&quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">stamps</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stamps</span><span class="p">)</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">ntasks</span><span class="p">)</span>

<span class="c">#</span>
<span class="c"># different ways of starting up a job</span>
<span class="k">def</span> <span class="nf">launcherqsubber</span><span class="p">(</span><span class="n">task</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="n">hosts</span><span class="p">,</span><span class="n">poolsize</span><span class="p">):</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s">&quot;qsub </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">line</span>
    <span class="k">return</span> <span class="n">command</span>

<div class="viewcode-block" id="Node"><a class="viewcode-back" href="../implementation.html#pylauncher.Node">[docs]</a><span class="k">class</span> <span class="nc">Node</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;A abstract object for a slot to execute a job. Most of the time</span>
<span class="sd">    this will correspond to a core.</span>

<span class="sd">    A node can have a task associated with it or be free.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">host</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">core</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">nodeid</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">core</span> <span class="o">=</span> <span class="n">core</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeid</span> <span class="o">=</span> <span class="n">nodeid</span><span class="p">;</span> 
        <span class="c"># two initializations before the first ``release`` call:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="bp">None</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_on_this_node</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<div class="viewcode-block" id="Node.occupyWithTask"><a class="viewcode-back" href="../implementation.html#pylauncher.Node.occupyWithTask">[docs]</a>    <span class="k">def</span> <span class="nf">occupyWithTask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">taskid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Occupy a node with a taskid&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskid</span> <span class="o">=</span> <span class="n">taskid</span></div>
<div class="viewcode-block" id="Node.release"><a class="viewcode-back" href="../implementation.html#pylauncher.Node.release">[docs]</a>    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make a node unoccupied&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Attempting to release a free node&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="bp">True</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks_on_this_node</span> <span class="o">+=</span> <span class="mi">1</span></div>
<div class="viewcode-block" id="Node.isfree"><a class="viewcode-back" href="../implementation.html#pylauncher.Node.isfree">[docs]</a>    <span class="k">def</span> <span class="nf">isfree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test whether a node is occupied&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">free</span></div>
    <span class="k">def</span> <span class="nf">nodestring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;X&quot;</span>
        <span class="k">else</span><span class="p">:</span>         <span class="k">return</span> <span class="nb">str</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskid</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;h:</span><span class="si">%s</span><span class="s">, c:</span><span class="si">%s</span><span class="s">, id:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">core</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeid</span><span class="p">))</span>
</div>
<span class="k">def</span> <span class="nf">testNode</span><span class="p">():</span>
    <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nn</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">Node</span><span class="p">()</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">nodeid</span><span class="o">==</span><span class="n">nn</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Node</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nn</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">Node</span><span class="p">()</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">nodeid</span><span class="o">==</span><span class="n">nn</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="HostLocator"><a class="viewcode-back" href="../implementation.html#pylauncher.HostLocator">[docs]</a><span class="k">class</span> <span class="nc">HostLocator</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;A description of a subset from a HostPool. A locator</span>
<span class="sd">    object is typically created when a task asks for a set of nodes</span>
<span class="sd">    from a HostPool. Thus, a locator inherits the executor</span>
<span class="sd">    from the host pool from which it is taken.</span>

<span class="sd">    The only locator objects allowed at the moment are consecutive subsets.</span>

<span class="sd">    :param pool: HostPool (optional)</span>
<span class="sd">    :param extent: number of nodes requested</span>
<span class="sd">    :param offset: location of the first node in the pool</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pool</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">extent</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">offset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Please specify extent and offset&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="o">=</span><span class="n">extent</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="o">+</span><span class="n">key</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Index </span><span class="si">%d</span><span class="s"> out of range for pool&quot;</span> <span class="o">%</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,(</span><span class="n">Node</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Strange node type: &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt; @ </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">),</span><span class="n">key</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>
    <span class="k">def</span> <span class="nf">firsthost</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="c">#.pool[self.offset]</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">hostname</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;Locator: size=</span><span class="si">%d</span><span class="s"> offset=</span><span class="si">%d</span><span class="s"> &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span><span class="nb">str</span><span class="p">([</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">)</span> <span class="p">]))</span>
</div>
<div class="viewcode-block" id="HostName"><a class="viewcode-back" href="../extend.html#pylauncher.HostName">[docs]</a><span class="k">def</span> <span class="nf">HostName</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;This just returns the hostname. See also ``ClusterName``.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">socket</span>
    <span class="k">return</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="HostPoolBase"><a class="viewcode-back" href="../trace.html#pylauncher.HostPoolBase">[docs]</a><span class="k">class</span> <span class="nc">HostPoolBase</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;A base class that defines some methods and sets up</span>
<span class="sd">    the basic data structures.</span>

<span class="sd">    :param commandexecutor: (keyword, optional, default=``LocalExecutor``) the ``Executor`` object for this host pool</span>
<span class="sd">    :param workdir: (keyword, optional) the workdir for the command executor</span>
<span class="sd">    :param debug: (keyword, optional) a string of debug types; if this contains &#39;host&#39;, anything derived from ``HostPoolBase`` will do a debug trace</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commandexecutor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;commandexecutor&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">workdir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;workdir&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commandexecutor</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commandexecutor</span> <span class="o">=</span> <span class="n">LocalExecutor</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">workdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;workdir arg is ignored with explicit executor&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;host&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debugs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Unprocessed HostPool args: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
<div class="viewcode-block" id="HostPoolBase.append_node"><a class="viewcode-back" href="../implementation.html#pylauncher.HostPoolBase.append_node">[docs]</a>    <span class="k">def</span> <span class="nf">append_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">host</span><span class="o">=</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span><span class="n">core</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new item in this pool by specifying either a Node object</span>
<span class="sd">        or a hostname plus core number. This function is called in a loop when a</span>
<span class="sd">        ``HostPool`` is created from a ``HostList`` object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">host</span><span class="p">,(</span><span class="n">Node</span><span class="p">)):</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">host</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">core</span><span class="p">,</span><span class="n">nodeid</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">node</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commandexecutor</span><span class="o">.</span><span class="n">setup_on_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pool</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pool</span> <span class="p">]</span>
<div class="viewcode-block" id="HostPoolBase.unique_hostnames"><a class="viewcode-back" href="../implementation.html#pylauncher.HostPoolBase.unique_hostnames">[docs]</a>    <span class="k">def</span> <span class="nf">unique_hostnames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pool</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of unique hostnames. In general each hostname appears</span>
<span class="sd">        16 times or so in a HostPool since each core is listed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pool</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">u</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hosts</span><span class="p">(</span><span class="n">pool</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">hostname</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">u</span><span class="p">:</span>
                <span class="n">u</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">u</span><span class="p">)</span></div>
<div class="viewcode-block" id="HostPoolBase.request_nodes"><a class="viewcode-back" href="../implementation.html#pylauncher.HostPoolBase.request_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">request_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Request a number of nodes; this returns a HostLocator object&quot;&quot;&quot;</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;request </span><span class="si">%d</span><span class="s"> nodes&quot;</span> <span class="o">%</span> <span class="n">request</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Host&quot;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>    
        <span class="k">while</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">start</span><span class="o">+</span><span class="n">request</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">start</span><span class="o">+</span><span class="n">request</span><span class="p">):</span>
                <span class="n">found</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isfree</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="k">break</span>
        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">locator</span> <span class="o">=</span> <span class="n">HostLocator</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="n">start</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
            <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;returning &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">locator</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Host&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">locator</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;could not locate&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Host&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span></div>
<div class="viewcode-block" id="HostPoolBase.occupyNodes"><a class="viewcode-back" href="../implementation.html#pylauncher.HostPoolBase.occupyNodes">[docs]</a>    <span class="k">def</span> <span class="nf">occupyNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">locator</span><span class="p">,</span><span class="n">taskid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Occupy nodes with a taskid</span>

<span class="sd">        Argument:</span>
<span class="sd">        * locator : HostLocator object</span>
<span class="sd">        * taskid : like the man says</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nodenums</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">locator</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span><span class="n">locator</span><span class="o">.</span><span class="n">offset</span><span class="o">+</span><span class="n">locator</span><span class="o">.</span><span class="n">extent</span><span class="p">)</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;occupying nodes </span><span class="si">%s</span><span class="s"> with </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">nodenums</span><span class="p">),</span><span class="n">taskid</span><span class="p">),</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Host&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodenums</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">occupyWithTask</span><span class="p">(</span><span class="n">taskid</span><span class="p">)</span></div>
<div class="viewcode-block" id="HostPoolBase.releaseNodesByTask"><a class="viewcode-back" href="../implementation.html#pylauncher.HostPoolBase.releaseNodesByTask">[docs]</a>    <span class="k">def</span> <span class="nf">releaseNodesByTask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">taskid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given a task id, release the nodes that are associated with it&quot;&quot;&quot;</span>
        <span class="n">done</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">taskid</span><span class="o">==</span><span class="n">taskid</span><span class="p">:</span>
                <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;releasing </span><span class="si">%s</span><span class="s">, core </span><span class="si">%s</span><span class="s">&quot;</span>
                              <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">hostname</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">core</span><span class="p">)),</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Host&quot;</span><span class="p">)</span>
                <span class="n">n</span><span class="o">.</span><span class="n">release</span><span class="p">();</span> <span class="n">done</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Could not find nodes associated with id </span><span class="si">%s</span><span class="s">&quot;</span>
                                    <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">taskid</span><span class="p">))</span></div>
<div class="viewcode-block" id="HostPoolBase.release"><a class="viewcode-back" href="../implementation.html#pylauncher.HostPoolBase.release">[docs]</a>    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If the executor opens ssh connections, we want to close them cleanly.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commandexecutor</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span></div>
<div class="viewcode-block" id="HostPoolBase.final_report"><a class="viewcode-back" href="../trace.html#pylauncher.HostPoolBase.final_report">[docs]</a>    <span class="k">def</span> <span class="nf">final_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string that reports how many tasks were run on each node.&quot;&quot;&quot;</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span> <span class="n">n</span><span class="o">.</span><span class="n">tasks_on_this_node</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span> <span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">Host pool of size </span><span class="si">%d</span><span class="s">.</span>

<span class="s">Number of tasks executed per node:</span>
<span class="s">max: </span><span class="si">%d</span><span class="s"></span>
<span class="s">avg: </span><span class="si">%d</span><span class="s"></span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">counts</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">message</span></div>
    <span class="k">def</span> <span class="nf">printhosts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hostlist</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">):</span>
            <span class="n">hostlist</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> : </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hostlist</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hostlist</span> <span class="o">=</span> <span class="nb">str</span> <span class="p">(</span> <span class="p">[</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="o">.</span><span class="n">nodestring</span><span class="p">()</span> <span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">hostlist</span>
</div>
<div class="viewcode-block" id="OneNodePool"><a class="viewcode-back" href="../testing.html#pylauncher.OneNodePool">[docs]</a><span class="k">class</span> <span class="nc">OneNodePool</span><span class="p">(</span><span class="n">HostPoolBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class is mostly for testing: it allows for a node to function</span>
<span class="sd">    as a host pool so that one can start a task on it.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">node</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">HostPoolBase</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,(</span><span class="n">Node</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Invalid node type &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="HostPool"><a class="viewcode-back" href="../implementation.html#pylauncher.HostPool">[docs]</a><span class="k">class</span> <span class="nc">HostPool</span><span class="p">(</span><span class="n">HostPoolBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A structure to manage a bunch of Node objects.</span>
<span class="sd">    The main internal object is the ``nodes`` member, which </span>
<span class="sd">    is a list of Node objects.</span>

<span class="sd">    :param nhosts: the number of slots in the pool; this will use the localhost</span>
<span class="sd">    :param hostlist: HostList object; this takes preference over the previous option</span>
<span class="sd">    :param commandexecutor: (optional) a prefixer routine, by default LocalExecutor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">HostPoolBase</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">commandexecutor</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;commandexecutor&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
               <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">))</span>
        <span class="n">hostlist</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;hostlist&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hostlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hostlist</span><span class="p">,(</span><span class="n">HostList</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;hostlist argument needs to be derived from HostList&quot;</span><span class="p">)</span>
        <span class="n">nhosts</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;nhosts&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hostlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">nhosts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hostlist</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hostlist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append_node</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">h</span><span class="p">[</span><span class="s">&#39;host&#39;</span><span class="p">],</span><span class="n">core</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s">&#39;core&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">nhosts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">localhost</span> <span class="o">=</span> <span class="n">HostName</span><span class="p">()</span>
            <span class="n">hostlist</span> <span class="o">=</span> <span class="p">[</span> <span class="n">localhost</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nhosts</span><span class="p">)</span> <span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nhosts</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append_node</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">localhost</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;HostPool creation needs n or list&quot;</span><span class="p">)</span>
        <span class="c">#self.nhosts = nhosts</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Unprocessed HostPool args: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;Created host pool from &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">hostlist</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Host&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The ``SSHExecutor`` class creates a permanent ssh connection, </span>
<span class="sd">        which we try to release by this mechanism.&quot;&quot;&quot;</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;Releasing nodes&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Host&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commandexecutor</span><span class="o">.</span><span class="n">release_from_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">testHostPoolN</span><span class="p">():</span>
    <span class="c"># get rid of old workdirs</span>
    <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">Executor</span><span class="o">.</span><span class="n">default_workdir</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
    <span class="c"># test</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">HostPool</span><span class="p">(</span><span class="n">nhosts</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="c"># request a 3 node pool</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">hosts</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">pool</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nodeid</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">pool</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">nodeid</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">task</span> <span class="o">=</span> <span class="mi">27</span>
    <span class="n">p</span><span class="o">.</span><span class="n">occupyNodes</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">task</span><span class="p">)</span>
    <span class="c"># it is not possible to get 4 more nodes</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">p2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>
    <span class="c"># see if the status is correctly rendered</span>
    <span class="k">assert</span><span class="p">(</span><span class="ow">not</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">free</span> <span class="ow">and</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">free</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nodestring</span><span class="p">()</span><span class="o">==</span><span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">nodestring</span><span class="p">()</span><span class="o">==</span><span class="s">&quot;X&quot;</span><span class="p">)</span>
    <span class="c"># after we release used pool, we can request more</span>
    <span class="n">p</span><span class="o">.</span><span class="n">releaseNodesByTask</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">)</span>
    <span class="c"># cleanup</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">testStartTaskOnPool</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="c"># get rid of old workdirs</span>
    <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">Executor</span><span class="o">.</span><span class="n">default_workdir</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
    <span class="c"># test</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="s">&quot;pwd.utest&quot;</span><span class="p">;</span> <span class="n">word</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/rm -f </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;echo </span><span class="si">%s</span><span class="s"> &gt; </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">word</span><span class="p">,</span><span class="n">fn</span><span class="p">))</span> <span class="p">)</span>
    <span class="n">task</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">();</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">();</span> <span class="k">print</span> <span class="n">l</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">l</span><span class="o">==</span><span class="n">word</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/rm -f </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># cleanup</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>

<div class="viewcode-block" id="HostList"><a class="viewcode-back" href="../implementation.html#pylauncher.HostList">[docs]</a><span class="k">class</span> <span class="nc">HostList</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Object describing a list of hosts. Each host is a dictionary</span>
<span class="sd">    with a ``host`` and ``core`` field.</span>

<span class="sd">    Arguments:</span>

<span class="sd">    * list : list of hostname strings</span>
<span class="sd">    * tag : something like ``.tacc.utexas.edu`` may be necessary to ssh to hosts in the list</span>

<span class="sd">    This is an iteratable object; it yields the host/core dictionary objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">list</span><span class="o">=</span><span class="p">[],</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostlist</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniquehosts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<div class="viewcode-block" id="HostList.append"><a class="viewcode-back" href="../implementation.html#pylauncher.HostList.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arguments:</span>

<span class="sd">        * h : hostname</span>
<span class="sd">        * c (optional, default zero) : core number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span>
        <span class="k">if</span> <span class="n">h</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">uniquehosts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uniquehosts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">{</span><span class="s">&#39;host&#39;</span><span class="p">:</span><span class="n">h</span><span class="p">,</span> <span class="s">&#39;core&#39;</span><span class="p">:</span><span class="n">c</span><span class="p">}</span> <span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostlist</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostlist</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">h</span>

<span class="c">####</span>
<span class="c">#### Customizable section</span>
<span class="c">####</span></div>
<div class="viewcode-block" id="SGEHostList"><a class="viewcode-back" href="../extend.html#pylauncher.SGEHostList">[docs]</a><span class="k">class</span> <span class="nc">SGEHostList</span><span class="p">(</span><span class="n">HostList</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">HostList</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">hostfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;PE_HOSTFILE&quot;</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hostfile</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hostfile</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hostfile</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">();</span> <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">();</span> <span class="n">host</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">n</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SLURMHostList"><a class="viewcode-back" href="../extend.html#pylauncher.SLURMHostList">[docs]</a><span class="k">class</span> <span class="nc">SLURMHostList</span><span class="p">(</span><span class="n">HostList</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">HostList</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">hlist_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;SLURM_NODELIST&quot;</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;SLURM_NNODES&quot;</span><span class="p">])</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;SLURM_NPROCS&quot;</span><span class="p">])</span>
        <span class="n">n</span><span class="o">=</span><span class="n">N</span><span class="o">/</span><span class="n">p</span>
        <span class="n">hlist</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">expand_hostlist</span><span class="p">(</span><span class="n">hlist_str</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hlist</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ClusterName"><a class="viewcode-back" href="../extend.html#pylauncher.ClusterName">[docs]</a><span class="k">def</span> <span class="nf">ClusterName</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Assuming that a node name is along the lines of ``c123-456.cluster.tacc.utexas.edu``</span>
<span class="sd">    this returns the second member. Otherwise it returns None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">longname</span> <span class="o">=</span> <span class="n">HostName</span><span class="p">();</span> <span class="n">namesplit</span> <span class="o">=</span> <span class="n">longname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span>
    <span class="c"># case: mic on stampede</span>
    <span class="n">nodesplit</span> <span class="o">=</span> <span class="n">namesplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodesplit</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">nodesplit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;mic0&quot;</span><span class="p">,</span><span class="s">&quot;mic1&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s">&quot;mic&quot;</span>
    <span class="c"># case: tacc cluster node</span>
    <span class="k">if</span> <span class="s">&quot;tacc&quot;</span> <span class="ow">in</span> <span class="n">namesplit</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">namesplit</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;c[0-9]&quot;</span><span class="p">,</span><span class="n">namesplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">namesplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
    <span class="c"># case: unknown</span>
    <span class="k">return</span> <span class="bp">None</span>
</div>
<span class="k">def</span> <span class="nf">ClusterHasSharedFileSystem</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;This test is only used in some unit tests&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ClusterName</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;ls4&quot;</span><span class="p">,</span><span class="s">&quot;stampede&quot;</span><span class="p">,</span><span class="s">&quot;mic&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="JobId"><a class="viewcode-back" href="../extend.html#pylauncher.JobId">[docs]</a><span class="k">def</span> <span class="nf">JobId</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;This function is installation dependent: it inspects the environment variable</span>
<span class="sd">    that holds the job ID, based on the actual name of the host (see</span>
<span class="sd">     ``HostName``): this should only return a number if we are actually in a job.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hostname</span> <span class="o">=</span> <span class="n">ClusterName</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">hostname</span><span class="o">==</span><span class="s">&quot;ls4&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;JOB_ID&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">hostname</span><span class="o">==</span><span class="s">&quot;stampede&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;SLURM_JOB_ID&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="HostListByName"><a class="viewcode-back" href="../extend.html#pylauncher.HostListByName">[docs]</a><span class="k">def</span> <span class="nf">HostListByName</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Give a proper hostlist. Currently this work for the following TACC hosts:</span>

<span class="sd">    * ``ls4``: Lonestar, using SGE</span>
<span class="sd">    * ``stampede``: Stampede, using SLURM</span>
<span class="sd">    * ``mic``: Intel Xeon PHI co-processor attached to a compute node</span>

<span class="sd">    We return a trivial hostlist otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="n">ClusterName</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cluster</span><span class="o">==</span><span class="s">&quot;ls4&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SGEHostList</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;.ls4.tacc.utexas.edu&quot;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cluster</span><span class="o">==</span><span class="s">&quot;stampede&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SLURMHostList</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;.stampede.tacc.utexas.edu&quot;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cluster</span><span class="o">==</span><span class="s">&quot;mic&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HostList</span><span class="p">(</span> <span class="p">[</span><span class="s">&quot;localhost&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">)]</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HostList</span><span class="p">(</span><span class="nb">list</span><span class="o">=</span><span class="p">[</span><span class="n">HostName</span><span class="p">()])</span>
        </div>
<span class="k">def</span> <span class="nf">testTACChostlist</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">HostListByName</span><span class="p">():</span>
        <span class="k">print</span> <span class="s">&quot;hostfile line:&quot;</span><span class="p">,</span><span class="n">h</span>
        <span class="k">assert</span><span class="p">(</span> <span class="s">&#39;core&#39;</span> <span class="ow">in</span> <span class="n">h</span> <span class="ow">and</span> <span class="s">&#39;host&#39;</span> <span class="ow">in</span> <span class="n">h</span> <span class="p">)</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s">&quot;host&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span>
        <span class="c">#assert( len(host)&gt;1 and host[1]==HostName() )</span>

<div class="viewcode-block" id="DefaultHostPool"><a class="viewcode-back" href="../implementation.html#pylauncher.DefaultHostPool">[docs]</a><span class="k">class</span> <span class="nc">DefaultHostPool</span><span class="p">(</span><span class="n">HostPool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A HostPool object based on the hosts obtained from the</span>
<span class="sd">    ``HostListByName`` function, and using the ``SSHExecutor`` function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">debugs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">hostlist</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;hostlist&quot;</span><span class="p">,</span><span class="n">HostListByName</span><span class="p">())</span>
        <span class="n">commandexecutor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;commandexecutor&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">commandexecutor</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ClusterName</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">commandexecutor</span> <span class="o">=</span> <span class="n">SSHExecutor</span><span class="p">(</span>
                    <span class="n">debug</span><span class="o">=</span><span class="n">debugs</span><span class="p">,</span><span class="n">force_workdir</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;force_workdir&quot;</span><span class="p">,</span><span class="bp">False</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">commandexecutor</span> <span class="o">=</span> <span class="n">LocalExecutor</span><span class="p">(</span>
                    <span class="n">debug</span><span class="o">=</span><span class="n">debugs</span><span class="p">,</span><span class="n">force_workdir</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;force_workdir&quot;</span><span class="p">,</span><span class="bp">False</span><span class="p">)),</span>
        <span class="n">HostPool</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">hostlist</span><span class="o">=</span><span class="n">hostlist</span><span class="p">,</span>
                           <span class="n">commandexecutor</span><span class="o">=</span><span class="n">commandexecutor</span><span class="p">,</span>
                           <span class="n">debug</span><span class="o">=</span><span class="n">debugs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">testPEhostpools</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;testPEhostpools: Test that we get the right number of cores on the TACC hosts&quot;&quot;&quot;</span>
    <span class="c"># get rid of old workdirs</span>
    <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">Executor</span><span class="o">.</span><span class="n">default_workdir</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
    <span class="c"># test</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="n">ClusterName</span><span class="p">()</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">DefaultHostPool</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cluster</span><span class="o">==</span><span class="s">&quot;stampede&quot;</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span><span class="o">%</span><span class="mi">16</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cluster</span><span class="o">==</span><span class="s">&quot;ls4&quot;</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span><span class="o">%</span><span class="mi">12</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># cleanup</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LocalHostPool</span><span class="p">(</span><span class="n">HostPool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A host pool based on just the localhost, using the ``LocalExecutor``. This is for testing purposes.</span>

<span class="sd">    :param n: (keyword, optional, default=1) number of times the localhost should be listed</span>
<span class="sd">    :param workdir: (keyword, optional) workdir for the commandexecutor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">HostPool</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span><span class="n">nhosts</span><span class="o">=</span><span class="n">n</span><span class="p">,</span><span class="n">commandexecutor</span><span class="o">=</span><span class="n">LocalExecutor</span><span class="p">(</span>
                <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
                <span class="n">workdir</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;workdir&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
                <span class="n">force_workdir</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;force_workdir&quot;</span><span class="p">,</span><span class="bp">False</span><span class="p">)),</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">testHostPoolWorkdirforcing</span><span class="p">():</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/rm -rf &quot;</span><span class="o">+</span><span class="n">Executor</span><span class="o">.</span><span class="n">default_workdir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">Executor</span><span class="o">.</span><span class="n">default_workdir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="n">Executor</span><span class="p">()</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">exc</span> <span class="o">=</span> <span class="n">Executor</span><span class="p">(</span><span class="n">force_workdir</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

<div class="viewcode-block" id="TaskQueue"><a class="viewcode-back" href="../trace.html#pylauncher.TaskQueue">[docs]</a><span class="k">class</span> <span class="nc">TaskQueue</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Object that does the maintains a list of Task objects.</span>
<span class="sd">    This is internally created inside a ``LauncherJob`` object.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxsimul</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">submitdelay</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Unprocessed TaskQueue args: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
<div class="viewcode-block" id="TaskQueue.isEmpty"><a class="viewcode-back" href="../implementation.html#pylauncher.TaskQueue.isEmpty">[docs]</a>    <span class="k">def</span> <span class="nf">isEmpty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test whether the queue is empty and no tasks running&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">==</span><span class="p">[]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="o">==</span><span class="p">[]</span></div>
<div class="viewcode-block" id="TaskQueue.enqueue"><a class="viewcode-back" href="../implementation.html#pylauncher.TaskQueue.enqueue">[docs]</a>    <span class="k">def</span> <span class="nf">enqueue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">task</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a task to the queue&quot;&quot;&quot;</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;enqueueing &lt;</span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Queue&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span></div>
<div class="viewcode-block" id="TaskQueue.startQueued"><a class="viewcode-back" href="../implementation.html#pylauncher.TaskQueue.startQueued">[docs]</a>    <span class="k">def</span> <span class="nf">startQueued</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">hostpool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;for all queued, try to find nodes to run it on;</span>
<span class="sd">        the hostpool argument is a HostPool object&quot;&quot;&quot;</span>
        <span class="n">tqueue</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span>
        <span class="n">tqueue</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="p">)</span>
        <span class="n">max_gap</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hostpool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tqueue</span><span class="p">:</span>
            <span class="c"># go through tasks in descending size</span>
            <span class="c"># if one doesn&#39;t fit, skip all of same size</span>
            <span class="n">requested_gap</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span>
            <span class="k">if</span> <span class="n">requested_gap</span><span class="o">&gt;</span><span class="n">max_gap</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">locator</span> <span class="o">=</span> <span class="n">hostpool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="n">requested_gap</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">locator</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;could not find nodes for &lt;</span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Queue&quot;</span><span class="p">)</span>
                <span class="n">max_gap</span> <span class="o">=</span> <span class="n">requested_gap</span><span class="o">-</span><span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">submitdelay</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">submitdelay</span><span class="p">)</span>
            <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;starting task &lt;</span><span class="si">%s</span><span class="s">&gt; on locator &lt;</span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">locator</span><span class="p">)),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Queue&quot;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">locator</span><span class="p">)</span>
            <span class="n">hostpool</span><span class="o">.</span><span class="n">occupyNodes</span><span class="p">(</span><span class="n">locator</span><span class="p">,</span><span class="n">t</span><span class="o">.</span><span class="n">taskid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxsimul</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxsimul</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">))</span></div>
<div class="viewcode-block" id="TaskQueue.find_recently_completed"><a class="viewcode-back" href="../implementation.html#pylauncher.TaskQueue.find_recently_completed">[docs]</a>    <span class="k">def</span> <span class="nf">find_recently_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the first recently completed task.</span>
<span class="sd">        Note the return, not yield.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">hasCompleted</span><span class="p">():</span>
                <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;.. job completed: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">taskid</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Queue&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">t</span>
        <span class="k">return</span> <span class="bp">None</span></div>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;completed: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">([</span> <span class="n">t</span><span class="o">.</span><span class="n">taskid</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">completed</span><span class="p">)])</span><span class="o">+</span><span class="s">&quot;;&quot;</span><span class="o">+</span>\
               <span class="s">&quot;</span><span class="se">\n</span><span class="s">queued: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">([</span> <span class="n">t</span><span class="o">.</span><span class="n">taskid</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">])</span><span class="o">+</span><span class="s">&quot;;&quot;</span><span class="o">+</span>\
               <span class="s">&quot;</span><span class="se">\n</span><span class="s">running: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">([</span> <span class="n">t</span><span class="o">.</span><span class="n">taskid</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">)])</span><span class="o">+</span><span class="s">&quot;.&quot;</span>
    <span class="k">def</span> <span class="nf">savestate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;queuestate&quot;</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;queued</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">:</span>     <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>   <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<div class="viewcode-block" id="TaskQueue.final_report"><a class="viewcode-back" href="../trace.html#pylauncher.TaskQueue.final_report">[docs]</a>    <span class="k">def</span> <span class="nf">final_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string describing the max and average runtime for each task.&quot;&quot;&quot;</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[</span> <span class="n">t</span><span class="o">.</span><span class="n">runningtime</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed</span><span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;# tasks completed: </span><span class="si">%d</span><span class="s"></span>
<span class="s">max runningtime: </span><span class="si">%6.2f</span><span class="s"></span>
<span class="s">avg runningtime: </span><span class="si">%6.2f</span><span class="s"></span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">completed</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span> <span class="n">times</span> <span class="p">),</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">times</span> <span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">completed</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">message</span>
</div></div>
<span class="k">def</span> <span class="nf">testTaskQueue</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;testTaskQueue: queue and detect a task in a queue</span>
<span class="sd">    using the default task prefixer and completion tester&quot;&quot;&quot;</span>
    <span class="c"># get rid of old workdirs</span>
    <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">Executor</span><span class="o">.</span><span class="n">default_workdir</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
    <span class="c"># test</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">HostPool</span><span class="p">(</span><span class="n">nhosts</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">TaskQueue</span><span class="p">()</span>
    <span class="n">nsleep</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">t_id</span> <span class="o">=</span> <span class="mi">13</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">RandomSleepTask</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">t_id</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">nsleep</span><span class="p">)</span>
    <span class="n">queue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="n">queue</span><span class="o">.</span><span class="n">startQueued</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">task</span> <span class="ow">in</span> <span class="n">queue</span><span class="o">.</span><span class="n">running</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nsleep</span><span class="p">)</span>
    <span class="n">complete_id</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">find_recently_completed</span><span class="p">()</span><span class="o">.</span><span class="n">taskid</span>
    <span class="k">print</span> <span class="s">&quot;found completed:&quot;</span><span class="p">,</span><span class="n">complete_id</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">complete_id</span><span class="o">==</span><span class="n">t_id</span><span class="p">)</span>
    <span class="n">task</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
    <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># cleanup</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">testTaskQueueWithLauncherdir</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;testTaskQueueWithLauncherdir: same, but test correct use of launcherdir&quot;&quot;&quot;</span>
    <span class="c"># get rid of old workdirs</span>
    <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">Executor</span><span class="o">.</span><span class="n">default_workdir</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
    <span class="c"># test</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">HostPool</span><span class="p">(</span><span class="n">nhosts</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">dirname</span> <span class="o">=</span> <span class="s">&quot;noselaunch&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;rm -rf </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dirname</span><span class="p">)</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">TaskQueue</span><span class="p">()</span>
    <span class="n">nsleep</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">t_id</span> <span class="o">=</span> <span class="mi">14</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">RandomSleepTask</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">t_id</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">nsleep</span><span class="p">,</span>
                           <span class="n">completion</span><span class="o">=</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">stampdir</span><span class="o">=</span><span class="n">dirname</span><span class="p">,</span><span class="n">taskid</span><span class="o">=</span><span class="n">t_id</span><span class="p">))</span>
    <span class="n">queue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="n">queue</span><span class="o">.</span><span class="n">startQueued</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">task</span> <span class="ow">in</span> <span class="n">queue</span><span class="o">.</span><span class="n">running</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nsleep</span><span class="p">)</span>
    <span class="n">complete_id</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">find_recently_completed</span><span class="p">()</span><span class="o">.</span><span class="n">taskid</span>
    <span class="k">print</span> <span class="s">&quot;completed:&quot;</span><span class="p">,</span><span class="n">complete_id</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">complete_id</span><span class="o">==</span><span class="n">t_id</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span><span class="c">#queue.launcherdir)</span>
    <span class="k">print</span> <span class="n">files</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/rm -rf </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dirname</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># cleanup</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>

<div class="viewcode-block" id="TaskGenerator"><a class="viewcode-back" href="../implementation.html#pylauncher.TaskGenerator">[docs]</a><span class="k">class</span> <span class="nc">TaskGenerator</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;iterator class that can yield the following:</span>

<span class="sd">    * a Task instance, or </span>
<span class="sd">    * the keyword ``stall``; this indicates that the commandline generator is stalling and this will be resolved when the outer environment does an ``append`` on the commandline generator.</span>
<span class="sd">    * the ``pylauncherBarrierString``; in this case the outer environment should not call the generator until all currently running tasks have concluded.</span>
<span class="sd">    * the keyword ``stop``; this means that the commandline generator is exhausted. The ``next`` function can be called repeatedly on a stopped generator.</span>

<span class="sd">    You can iterate over an instance, or call the ``next`` method. The ``next`` method</span>
<span class="sd">    can accept an imposed taskcount number.</span>

<span class="sd">    :param commandlinegenerator: either a list of unix commands, or a CommandlineGenerator object</span>
<span class="sd">    :param completion: (optional) a function of one variable (the task id) that returns Completion objects</span>
<span class="sd">    :param debug: (optional) string of requested debug modes</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">commandlines</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">commandlines</span><span class="p">,(</span><span class="nb">list</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commandlinegenerator</span> <span class="o">=</span> <span class="n">ListCommandlineGenerator</span><span class="p">(</span><span class="nb">list</span><span class="o">=</span><span class="n">commandlines</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">commandlines</span><span class="p">,(</span><span class="n">CommandlineGenerator</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commandlinegenerator</span> <span class="o">=</span> <span class="n">commandlines</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Invalid commandline generator object&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">paused</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;task&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debugs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completion</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;completion&quot;</span><span class="p">,</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">Completion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">x</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Unprocessed TaskGenerator args: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
<div class="viewcode-block" id="TaskGenerator.next"><a class="viewcode-back" href="../implementation.html#pylauncher.TaskGenerator.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">imposedcount</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deliver a Task object, or a special string:</span>

<span class="sd">        * &quot;stall&quot; : the commandline generator will give more, all in good time</span>
<span class="sd">        * &quot;stop&quot; : we are totally done</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">comm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commandlinegenerator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">comm</span><span class="p">[</span><span class="s">&quot;command&quot;</span><span class="p">]</span>
            <span class="c"># DebugTraceMsg(&quot;commandline generator ran out&quot;,</span>
            <span class="c">#               self.debug,prefix=&quot;Task&quot;)</span>
            <span class="c"># command = &quot;stop&quot;</span>
        <span class="k">if</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;stall&quot;</span><span class="p">,</span><span class="s">&quot;stop&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">command</span>
        <span class="k">elif</span> <span class="n">command</span><span class="o">==</span><span class="n">pylauncherBarrierString</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">command</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imposedcount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">taskid</span> <span class="o">=</span> <span class="n">imposedcount</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">taskid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskcount</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">taskcount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span>
                        <span class="n">taskid</span><span class="o">=</span><span class="n">taskid</span><span class="p">,</span>
                        <span class="n">completion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span><span class="n">taskid</span><span class="p">),</span>
                        <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debugs</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span>
</div>
<div class="viewcode-block" id="TaskGeneratorIterate"><a class="viewcode-back" href="../implementation.html#pylauncher.TaskGeneratorIterate">[docs]</a><span class="k">def</span> <span class="nf">TaskGeneratorIterate</span><span class="p">(</span> <span class="n">gen</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;In case you want to iterate over a TaskGenerator, </span>
<span class="sd">    use this generator routine&quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="s">&quot;stop&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">yield</span> <span class="n">t</span>
</div>
<span class="k">class</span> <span class="nc">TestTaskGenerators</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">countedcommand</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">icommand</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">icommand</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="s">&quot;/bin/true command</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">count</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;make a commandlines file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="s">&quot;unittestlines&quot;</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="s">&quot;tmp_dir&quot;</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span> <span class="o">=</span> <span class="mi">60</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">icommand</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">commandlines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">5</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">commandlines</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;# arbitrary comment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">7</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">commandlines</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">commandlines</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">countedcommand</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">commandlines</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;rm -rf </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">testFileTaskGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testFileTaskGenerator: test that the taskgenerator can deal with a file&quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">TaskGenerator</span><span class="p">(</span> <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="s">&quot;command&quot;</span><span class="p">),</span>
                           <span class="n">debug</span><span class="o">=</span><span class="s">&quot;task&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">t</span>  <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> s/b </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">count</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testFileTaskGeneratorIteratable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testFileTaskGeneratorIteratable: test that the taskgenerator can deal with a file&quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">TaskGeneratorIterate</span><span class="p">(</span> <span class="n">TaskGenerator</span><span class="p">(</span> 
                <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="s">&quot;command&quot;</span><span class="p">),</span>
                <span class="n">debug</span><span class="o">=</span><span class="s">&quot;task&quot;</span><span class="p">)</span> <span class="p">):</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> s/b </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">count</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testFileTaskGeneratorNext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testFileTaskGeneratorNext: file task generator, but using a while/next loop&quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">generator</span> <span class="o">=</span> <span class="n">TaskGenerator</span><span class="p">(</span> 
            <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="s">&quot;command&quot;</span><span class="p">),</span>
            <span class="n">debug</span><span class="o">=</span><span class="s">&quot;task&quot;</span><span class="p">)</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">starttime</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;this is taking too long&quot;</span>
                <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> s/b </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">count</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testDynamicTaskGeneratorLong</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testDynamicTaskGeneratorLong: generate tasks until dynamic finish&quot;&quot;&quot;</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="o">+</span><span class="mi">10</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">TaskGenerator</span><span class="p">(</span> <span class="n">DynamicCommandlineGenerator</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="s">&quot;command&quot;</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">count</span><span class="o">&gt;=</span><span class="n">nmax</span><span class="p">:</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">commandlinegenerator</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">commandlinegenerator</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Commandline</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">countedcommand</span><span class="p">())</span> <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span> <span class="s">&quot;count </span><span class="si">%d</span><span class="s"> s/b </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="n">nmax</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">count</span><span class="o">==</span><span class="n">nmax</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testDynamicTaskGeneratorShort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testDynamicTaskGeneratorShort: generate tasks until dynamic finish&quot;&quot;&quot;</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="o">-</span><span class="mi">10</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">TaskGenerator</span><span class="p">(</span> <span class="n">DynamicCommandlineGenerator</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="s">&quot;command&quot;</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">count</span><span class="o">==</span><span class="n">nmax</span><span class="p">:</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">commandlinegenerator</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">generator</span><span class="o">.</span><span class="n">commandlinegenerator</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Commandline</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">countedcommand</span><span class="p">())</span> <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span> <span class="s">&quot;count </span><span class="si">%d</span><span class="s"> s/b </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="n">nmax</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">count</span><span class="o">==</span><span class="n">nmax</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ttestTaskGeneratorTmpDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">;</span> <span class="n">pool</span> <span class="o">=</span> <span class="n">HostPool</span><span class="p">(</span><span class="n">nhosts</span><span class="o">=</span><span class="n">nmax</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">TaskGeneratorIterate</span><span class="p">(</span> <span class="n">TaskGenerator</span><span class="p">(</span> <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
              <span class="n">completion</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">stampdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span> <span class="p">)</span> <span class="p">):</span>
            <span class="n">locator</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">locator</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;there should be space&quot;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">);</span> <span class="k">print</span> <span class="n">files</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="o">==</span><span class="n">nmax</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">testModuleCommandline</span><span class="p">():</span>
    <span class="n">ntasks</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span> <span class="n">fn</span> <span class="o">=</span> <span class="s">&quot;modtest&quot;</span>
    <span class="n">MakeRandomSleepFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">ntasks</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/rm -f </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">environment_list</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;This function takes a command and turns it into</span>
<span class="sd">    </span>
<span class="sd">    ``cd workdir ; env [the current environment] command``</span>

<span class="sd">    Note: environment variables with a space, semicolon, or parentheses</span>
<span class="sd">    are not transferred.</span>

<span class="sd">    :param command: a unix command, including semicolons and whatnot</span>
<span class="sd">    :param workdir: if this is None, the ssh connection will cd to the current directory, otherwise it will go to this workdir. If this is a relative path, it is taken relative to the current directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">listcommand</span> <span class="o">=</span> <span class="s">&quot;cd </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;PWD&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
        <span class="c">#val = re.sub(&#39;\(&#39;,&#39;\(&#39;,val); val = re.sub(&#39;\)&#39;,&#39;\)&#39;,val)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;[; ()]&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
            <span class="n">listcommand</span> <span class="o">+=</span> <span class="s">&quot;export </span><span class="si">%s</span><span class="s">=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">listcommand</span>

<div class="viewcode-block" id="Executor"><a class="viewcode-back" href="../implementation.html#pylauncher.Executor">[docs]</a><span class="k">class</span> <span class="nc">Executor</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Class for starting a commandline on some actual computing device.</span>

<span class="sd">    All derived classes need to define a ``execute`` method.</span>

<span class="sd">    :param catch_output: (keyword, optional, default=True) state whether command output gets caught, or just goes to stdout</span>
<span class="sd">    :param workdir: (optional, default=&quot;pylauncher_tmpdir_exec&quot;) directory for exec and out files</span>
<span class="sd">    :param debug: (optional) string of debug modes; include &quot;exec&quot; to trace this class</span>

<span class="sd">    Important note: the ``workdir`` should not already exist. You have to remove it yourself.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_workdir</span> <span class="o">=</span> <span class="s">&quot;pylauncher_tmpdir_exec&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catch_output</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;catch_output&quot;</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">catch_output</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append_output</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;append_output&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;exec&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debugs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">workdir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;workdir&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">workdir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_workdir</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">workdir</span>
        <span class="n">force_workdir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;force_workdir&quot;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s">&quot;/&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;Using executor workdir &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Exec&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span>
                <span class="s">&quot;Serious problem creating executor workdir &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">force_workdir</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/rm -rf </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span>
                    <span class="s">&quot;I will not reuse an executor workdir &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir_is_safe</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Unsafe working dir &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;; pls remove&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Unprocessed Executor args: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
<div class="viewcode-block" id="Executor.workdir_is_safe"><a class="viewcode-back" href="../implementation.html#pylauncher.Executor.workdir_is_safe">[docs]</a>    <span class="k">def</span> <span class="nf">workdir_is_safe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test that the working directory is (in) a subdirectory of the cwd&quot;&quot;&quot;</span>
        <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">();</span> <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">);</span> <span class="n">there</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">();</span> <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">here</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">here</span><span class="p">,</span><span class="n">there</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">here</span><span class="o">==</span><span class="n">there</span></div>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir_is_safe</span><span class="p">():</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setup_on_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">node</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="k">def</span> <span class="nf">release_from_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">node</span><span class="p">):</span>
        <span class="k">return</span>
<div class="viewcode-block" id="Executor.wrap"><a class="viewcode-back" href="../implementation.html#pylauncher.Executor.wrap">[docs]</a>    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">command</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Take a commandline, write it to a small file, and return the </span>
<span class="sd">        commandline that sources that file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">execfilename</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/exec</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">execfilename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;exec file already exists &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="n">execfilename</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">execfilename</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;#!/bin/bash</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">+</span><span class="n">command</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">execfilename</span><span class="p">,</span><span class="n">stat</span><span class="o">.</span><span class="n">S_IXUSR</span><span class="o">++</span><span class="n">stat</span><span class="o">.</span><span class="n">S_IXGRP</span><span class="o">+</span><span class="n">stat</span><span class="o">.</span><span class="n">S_IXOTH</span><span class="o">+</span>\
                     <span class="n">stat</span><span class="o">.</span><span class="n">S_IWUSR</span><span class="o">++</span><span class="n">stat</span><span class="o">.</span><span class="n">S_IWGRP</span><span class="o">+</span><span class="n">stat</span><span class="o">.</span><span class="n">S_IWOTH</span><span class="o">+</span>\
                     <span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span><span class="o">++</span><span class="n">stat</span><span class="o">.</span><span class="n">S_IRGRP</span><span class="o">+</span><span class="n">stat</span><span class="o">.</span><span class="n">S_IROTH</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">catch_output</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">pipe</span> <span class="o">=</span> <span class="s">&quot;&gt;&gt;&quot;</span>
                <span class="n">execoutname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_output</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">pipe</span> <span class="o">=</span> <span class="s">&quot;&gt;&quot;</span>
                <span class="n">execoutname</span> <span class="o">=</span>  <span class="s">&quot;</span><span class="si">%s</span><span class="s">/out</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
            <span class="n">wrappedcommand</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> 2&gt;&amp;1&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">execfilename</span><span class="p">,</span><span class="n">pipe</span><span class="p">,</span><span class="n">execoutname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wrappedcommand</span> <span class="o">=</span> <span class="n">execfilename</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;file &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;</span><span class="se">\n</span><span class="s">contains &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;</span><span class="se">\n</span><span class="s">new commandline &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> \
                          <span class="p">(</span><span class="n">execfilename</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">wrappedcommand</span><span class="p">),</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Exec&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">wrappedcommand</span></div>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Should not call default execute&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>
</div>
<span class="k">def</span> <span class="nf">testExecutorTmpDir</span><span class="p">():</span>
    <span class="c"># cleanup from failed tests</span>
    <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/abc&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
    <span class="c"># test</span>
    <span class="n">here</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="k">assert</span><span class="p">(</span> <span class="n">Executor</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="s">&quot;abc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">workdir_is_safe</span><span class="p">()</span> <span class="p">)</span>
    <span class="n">there</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">here</span><span class="o">==</span><span class="n">there</span><span class="p">)</span>
    <span class="c"># cleanup</span>
    <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/abc&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">testExecutorTmpDirRandom</span><span class="p">():</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="s">&quot;a</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">RandomID</span><span class="p">();</span> <span class="k">print</span> <span class="s">&quot;testing with executor tmpdir&quot;</span><span class="p">,</span><span class="n">wd</span>
    <span class="c"># cleanup from failed tests</span>
    <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">wd</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
    <span class="c"># test</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">Executor</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">wd</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">wd</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">x</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
    <span class="k">assert</span><span class="p">(</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">wd</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">Executor</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="s">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">Executor</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="s">&quot;..&quot;</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">Executor</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="s">&quot;../foo&quot;</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="c"># cleanup from failed tests</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>

<div class="viewcode-block" id="LocalExecutor"><a class="viewcode-back" href="../implementation.html#pylauncher.LocalExecutor">[docs]</a><span class="k">class</span> <span class="nc">LocalExecutor</span><span class="p">(</span><span class="n">Executor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Execute a commandline locally, in the background.</span>

<span class="sd">    :param prefix: (keyword, optional, default null string) for recalcitrant shells, the possibility to specify &#39;/bin/sh&#39; or so</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">Executor</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;Created local Executor&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Exec&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">fullcommandline</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s"> &amp; &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span><span class="n">wrapped</span><span class="p">)</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;subprocess execution of:</span><span class="se">\n</span><span class="s">&lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="n">fullcommandline</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Exec&quot;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">fullcommandline</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">env</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="c"># !!! why that os.environ and the env prefix?</span>
</div>
<span class="k">def</span> <span class="nf">testLocalExecutor</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;testLocalExecutor: check that local execution works&quot;&quot;&quot;</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="n">NoRandomDir</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">LocalExecutor</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="s">&quot;exec&quot;</span><span class="p">,</span><span class="n">workdir</span><span class="o">=</span><span class="n">wd</span><span class="p">)</span>
    <span class="n">touched</span> <span class="o">=</span> <span class="n">RandomFile</span><span class="p">()</span>
    <span class="n">x</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;touch </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">touched</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">wd</span><span class="p">))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">wd</span><span class="o">+</span><span class="s">&quot;/exec0&quot;</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">wd</span><span class="o">+</span><span class="s">&quot;/out0&quot;</span><span class="p">))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">touched</span><span class="p">))</span>
    <span class="n">x</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/rm -f </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">touched</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">wd</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">testLocalHostPool</span><span class="p">():</span>
    <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">Executor</span><span class="o">.</span><span class="n">default_workdir</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">LocalHostPool</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="s">&quot;host+exec&quot;</span><span class="p">)</span>
    <span class="n">tval</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">RandomSleepTask</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">tval</span><span class="p">,</span><span class="n">tmin</span><span class="o">=</span><span class="n">tval</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">RandomSleepTask</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">tval</span><span class="p">,</span><span class="n">tmin</span><span class="o">=</span><span class="n">tval</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">loc1</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">loc1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">t1</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">loc1</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">occupyNodes</span><span class="p">(</span><span class="n">loc1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">loc2</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">loc2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">t1</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">loc2</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">occupyNodes</span><span class="p">(</span><span class="n">loc2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">releaseNodesByTask</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">releaseNodesByTask</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ssh_client</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">paramiko</span>
    <span class="n">ssh</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
    <span class="n">ssh</span><span class="o">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="o">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Create paramiko ssh client to&quot;</span><span class="p">,</span><span class="n">host</span>
    <span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ssh</span>

<div class="viewcode-block" id="SSHExecutor"><a class="viewcode-back" href="../implementation.html#pylauncher.SSHExecutor">[docs]</a><span class="k">class</span> <span class="nc">SSHExecutor</span><span class="p">(</span><span class="n">Executor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prepend a command with an ssh to the pool;</span>
<span class="sd">    this also does a ``cd`` to the current directory, and </span>
<span class="sd">    sets up the current environment. </span>

<span class="sd">    Note: environment variables with a space, semicolon, or parentheses</span>
<span class="sd">    are not transferred.</span>

<span class="sd">    :param command: a unix command, including semicolons and whatnot</span>
<span class="sd">    :param pool: a HostLocator object</span>
<span class="sd">    :param workdir: if this is None, the ssh connection will cd to the current directory, otherwise it will go to this workdir. If this is a relative path, it is taken relative to the current directory.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_client_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">Executor</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debugs</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;ssh&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debugs</span><span class="p">)</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;Created SSH Executor&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Exec&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setup_on_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">node</span><span class="p">):</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">hostname</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;Set up connection to &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="n">host</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;SSH&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">host</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_client_dict</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ssh_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_client_dict</span><span class="p">[</span><span class="n">host</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ssh_client_unique</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ssh_client</span> <span class="o">=</span> <span class="n">ssh_client</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ssh_client_unique</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_client_dict</span><span class="p">[</span><span class="n">host</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">ssh_client</span>
    <span class="k">def</span> <span class="nf">release_from_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">ssh_client_unique</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ssh_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<div class="viewcode-block" id="SSHExecutor.execute"><a class="viewcode-back" href="../implementation.html#pylauncher.SSHExecutor.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">usercommand</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute a commandline by </span>

<span class="sd">        * making an ssh connection to the host locator; this uses ``paramiko``;</span>
<span class="sd">        * cd to the current directory;</span>
<span class="sd">        * setting up the environment (we filter out variables with semicolon, space, or parentheses in the name or value); and</span>
<span class="sd">        * executing the command in the background</span>

<span class="sd">        :param pool: (required) either a Node or HostLocator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;pool&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pool</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;SSHExecutor needs explicit HostPool&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pool</span><span class="p">,(</span><span class="n">Node</span><span class="p">)):</span>
            <span class="n">hostname</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">hostname</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pool</span><span class="p">,(</span><span class="n">HostLocator</span><span class="p">)):</span>
            <span class="n">hostname</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">firsthost</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Invalid pool &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">pool</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Unprocessed SSHExecutor args: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="n">env_line</span> <span class="o">=</span> <span class="n">environment_list</span><span class="p">()</span>
        <span class="n">wrapped_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">env_line</span><span class="o">+</span><span class="n">usercommand</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;Executing &lt;&lt; ( </span><span class="si">%s</span><span class="s"> ) &amp; &gt;&gt; on &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wrapped_line</span><span class="p">,</span><span class="n">hostname</span><span class="p">),</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;SSH&quot;</span><span class="p">)</span>
        <span class="n">ssh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_client_dict</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s">&quot;( </span><span class="si">%s</span><span class="s"> ) &amp;&quot;</span> <span class="o">%</span> <span class="n">wrapped_line</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ChannelException</span><span class="p">:</span>
            <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;Channel exception; let&#39;s see if this blows over&quot;</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;SSH&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s">&quot;( </span><span class="si">%s</span><span class="s"> ) &amp;&quot;</span> <span class="o">%</span> <span class="n">wrapped_line</span><span class="p">)</span>
</div></div>
<span class="k">class</span> <span class="nc">testPermanentSSHconnection</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stampname</span> <span class="o">=</span> <span class="s">&quot;prefixtasktest&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s">&quot;rm -f </span><span class="si">%s</span><span class="s">*&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">stampname</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s">&quot;rm -f </span><span class="si">%s</span><span class="s">*&quot;</span> <span class="o">%</span> <span class="n">FileCompletion</span><span class="o">.</span><span class="n">stamproot</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s">&quot;rm -f </span><span class="si">%s</span><span class="s">*&quot;</span> <span class="o">%</span> <span class="n">RandomSleepTask</span><span class="o">.</span><span class="n">stamproot</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">Executor</span><span class="o">.</span><span class="n">default_workdir</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">testRemoteSSH</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testRemoteSSH: This tests whether we we ssh to the right host.</span>
<span class="sd">        Create a task that pipes the output of `hostname&#39; to a file,</span>
<span class="sd">        then read that file (why do we do this with subprocess? </span>
<span class="sd">        it uses the shared filesystem anyway) and compare the contents</span>
<span class="sd">        to where we ssh&#39;ed.&quot;&quot;&quot;</span>
        <span class="n">hosts</span> <span class="o">=</span> <span class="n">DefaultHostPool</span><span class="p">()</span><span class="o">.</span><span class="n">unique_hostnames</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hosts</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;available hosts:&quot;</span><span class="p">,</span><span class="n">hosts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">HostPool</span><span class="p">(</span><span class="n">hostlist</span><span class="o">=</span><span class="n">HostList</span><span class="p">([</span><span class="n">hosts</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span>
                            <span class="n">commandexecutor</span><span class="o">=</span><span class="n">SSHExecutor</span><span class="p">())</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s">&quot;testremotessh&quot;</span><span class="p">;</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">fn</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;hostname &gt; </span><span class="si">%s</span><span class="s">; sleep 1&quot;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">HostLocator</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ClusterHasSharedFileSystem</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">outfile</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">();</span> <span class="k">print</span> <span class="s">&quot;&lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt; &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">hosts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">assert</span><span class="p">(</span><span class="n">line</span><span class="o">==</span><span class="n">hosts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">break</span>
                <span class="k">except</span><span class="p">:</span> 
                    <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s">&quot;cat </span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pwd</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="n">hostread</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">();</span> <span class="k">print</span> <span class="n">hostread</span>
                <span class="k">assert</span><span class="p">(</span><span class="n">hostread</span><span class="o">==</span><span class="n">hosts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/rm -f </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testSSHImmediateIssue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testSSHImmediateIssue: make sure ssh tasks are run in the background&quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">RandomSleepTask</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">stamproot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">DefaultHostPool</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">HostLocator</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span>
        <span class="k">print</span> <span class="s">&quot;elapsed time for an ssh&quot;</span><span class="p">,</span><span class="n">elapsed</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">elapsed</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ttestSSHbusy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testSSHbusy: start a couple of sleep tasks and confirm their existence.</span>
<span class="sd">        This uses a local ps through subprocess.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">DefaultHostPool</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="s">&quot;host+exec+ssh&quot;</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span> <span class="n">RandomSleepTask</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">tmin</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="s">&quot;task+exec&quot;</span><span class="p">)</span> 
                  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">sshstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span> <span class="n">pool</span><span class="o">=</span><span class="n">HostLocator</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">hasCompleted</span><span class="p">()</span> <span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">sshstart</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">t</span><span class="o">&gt;=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">hasCompleted</span><span class="p">()</span> <span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span> <span class="n">task</span><span class="o">.</span><span class="n">isRunning</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">ps_command</span> <span class="o">=</span> <span class="s">&quot;ps guwax | grep exec[0-9]&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">ps_command</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">psread</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="c"># stdout, strip \n, split</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span> <span class="n">task</span><span class="o">.</span><span class="n">hasCompleted</span><span class="p">()</span> <span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;ps lines:&quot;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psread</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">p</span>
        <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">psread</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">psread</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span> <span class="c"># once wrapped with chmod 777, once by itself.</span>
    <span class="k">def</span> <span class="nf">testSSHLeaveStamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testSSHLeaveStamp: leave a single stampfile&quot;&quot;&quot;</span>
        <span class="n">nsleep</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">taskid</span> <span class="o">=</span> <span class="n">RandomID</span><span class="p">()</span>
        <span class="n">taccpool</span> <span class="o">=</span> <span class="n">DefaultHostPool</span><span class="p">(</span><span class="n">commandexecutor</span><span class="o">=</span><span class="n">SSHExecutor</span><span class="p">())</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">RandomSleepTask</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">taskid</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">nsleep</span><span class="p">,</span><span class="n">stamproot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="s">&quot;task&quot;</span><span class="p">)</span>
        <span class="n">nodepool</span> <span class="o">=</span> <span class="n">taccpool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">nodepool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;available pool:&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">nodepool</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">nodepool</span><span class="o">.</span><span class="n">offset</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">nodepool</span><span class="p">)</span>
        <span class="n">taccpool</span><span class="o">.</span><span class="n">occupyNodes</span><span class="p">(</span><span class="n">nodepool</span><span class="p">,</span><span class="n">t</span><span class="o">.</span><span class="n">taskid</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nsleep</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">curdir</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">stampdir</span><span class="p">;</span> <span class="n">dircontent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">curdir</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;looking for stamps in &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt; and found &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="n">curdir</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dircontent</span><span class="p">))</span>
        <span class="n">stamps</span> <span class="o">=</span> <span class="p">[</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dircontent</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">print</span> <span class="s">&quot;stamps:&quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">stamps</span><span class="p">)</span>
        <span class="n">wanted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">taskid</span><span class="p">);</span> <span class="k">print</span> <span class="s">&quot;wanted:&quot;</span><span class="p">,</span><span class="n">wanted</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">wanted</span> <span class="ow">in</span> <span class="n">stamps</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testSSHLeaveStampLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testSSHLeaveStampLoop: make sure tasks leave a stampfile&quot;&quot;&quot;</span>
        <span class="n">ntasks</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">nsleep</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">taccpool</span> <span class="o">=</span> <span class="n">DefaultHostPool</span><span class="p">(</span><span class="n">commandexecutor</span><span class="o">=</span><span class="n">SSHExecutor</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">ntasks</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">taccpool</span><span class="p">):</span> <span class="c"># just to make sure we can run this</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">itask</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntasks</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">RandomSleepTask</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">itask</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">nsleep</span><span class="p">,</span><span class="n">stamproot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="p">)</span>
                <span class="n">nodepool</span> <span class="o">=</span> <span class="n">taccpool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nodepool</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="c"># there should be enough nodes open</span>
                <span class="k">print</span> <span class="s">&quot;available pool:&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">nodepool</span><span class="p">)</span>
                <span class="k">assert</span><span class="p">(</span><span class="n">nodepool</span><span class="o">.</span><span class="n">offset</span><span class="o">==</span><span class="n">itask</span><span class="p">)</span>
                <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">nodepool</span><span class="p">)</span>
                <span class="n">taccpool</span><span class="o">.</span><span class="n">occupyNodes</span><span class="p">(</span><span class="n">nodepool</span><span class="p">,</span><span class="n">t</span><span class="o">.</span><span class="n">taskid</span><span class="p">)</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">;</span> <span class="k">print</span> <span class="s">&quot;this took </span><span class="si">%e</span><span class="s"> seconds&quot;</span> <span class="o">%</span> <span class="n">interval</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">interval</span><span class="o">&lt;</span><span class="n">ntasks</span><span class="o">*.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nsleep</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">dir</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">stampdir</span><span class="p">;</span> <span class="n">dircontent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;looking for stamps and found:&quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dircontent</span><span class="p">)</span>
            <span class="n">stamps</span> <span class="o">=</span> <span class="p">[</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dircontent</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="p">]</span>
            <span class="k">print</span> <span class="s">&quot;stamps:&quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">stamps</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stamps</span><span class="p">)</span><span class="o">==</span><span class="n">ntasks</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testSSHLeaveLocalResult</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testSSHLeaveLocalResult: create a file and detect that it&#39;s there&quot;&quot;&quot;</span>
        <span class="n">nsleep</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">taskid</span> <span class="o">=</span> <span class="n">RandomID</span><span class="p">()</span>
        <span class="n">taccpool</span> <span class="o">=</span> <span class="n">DefaultHostPool</span><span class="p">(</span><span class="n">commandexecutor</span><span class="o">=</span><span class="n">SSHExecutor</span><span class="p">())</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">RandomFile</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;touch </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tmpfile</span><span class="p">),</span><span class="n">taskid</span><span class="o">=</span><span class="n">taskid</span><span class="p">,</span>
                 <span class="n">completion</span><span class="o">=</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">taskid</span><span class="p">),</span><span class="n">debug</span><span class="o">=</span><span class="s">&quot;task&quot;</span><span class="p">)</span>
        <span class="n">nodepool</span> <span class="o">=</span> <span class="n">taccpool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">nodepool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">nodepool</span><span class="p">)</span>
        <span class="n">taccpool</span><span class="o">.</span><span class="n">occupyNodes</span><span class="p">(</span><span class="n">nodepool</span><span class="p">,</span><span class="n">t</span><span class="o">.</span><span class="n">taskid</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nsleep</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">test</span><span class="p">())</span>
        <span class="k">print</span> <span class="s">&quot;stampdir:&quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">stampdir</span><span class="p">))</span>
        <span class="n">dircontent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="k">print</span> <span class="s">&quot;looking for result locally and found &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dircontent</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">tmpfile</span> <span class="ow">in</span> <span class="n">dircontent</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testSSHLeaveStampLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testSSHLeaveStampLoop: make sure tasks leave a stampfile&quot;&quot;&quot;</span>
        <span class="n">ntasks</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">nsleep</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">taccpool</span> <span class="o">=</span> <span class="n">DefaultHostPool</span><span class="p">(</span><span class="n">commandexecutor</span><span class="o">=</span><span class="n">SSHExecutor</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">ntasks</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">taccpool</span><span class="p">):</span> <span class="c"># just to make sure we can run this</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">itask</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntasks</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">RandomSleepTask</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">itask</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">nsleep</span><span class="p">,</span><span class="n">stamproot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="p">)</span>
                <span class="n">nodepool</span> <span class="o">=</span> <span class="n">taccpool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nodepool</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="c"># there should be enough nodes open</span>
                <span class="k">print</span> <span class="s">&quot;available pool:&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">nodepool</span><span class="p">)</span>
                <span class="k">assert</span><span class="p">(</span><span class="n">nodepool</span><span class="o">.</span><span class="n">offset</span><span class="o">==</span><span class="n">itask</span><span class="p">)</span>
                <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">nodepool</span><span class="p">)</span>
                <span class="n">taccpool</span><span class="o">.</span><span class="n">occupyNodes</span><span class="p">(</span><span class="n">nodepool</span><span class="p">,</span><span class="n">t</span><span class="o">.</span><span class="n">taskid</span><span class="p">)</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">;</span> <span class="k">print</span> <span class="s">&quot;this took </span><span class="si">%e</span><span class="s"> seconds&quot;</span> <span class="o">%</span> <span class="n">interval</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">interval</span><span class="o">&lt;</span><span class="n">ntasks</span><span class="o">*.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nsleep</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">dir</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">stampdir</span><span class="p">;</span> <span class="n">dircontent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;looking for stamps and found:&quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dircontent</span><span class="p">)</span>
            <span class="n">stamps</span> <span class="o">=</span> <span class="p">[</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dircontent</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">stampname</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="p">]</span>
            <span class="k">print</span> <span class="s">&quot;stamps:&quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">stamps</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stamps</span><span class="p">)</span><span class="o">==</span><span class="n">ntasks</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testRemoteSSHEnv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testRemoteSSHEnv: This tests whether the environment is propagated.</span>
<span class="sd">        We set an environment variable, and start a process that prints it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hosts</span> <span class="o">=</span> <span class="n">DefaultHostPool</span><span class="p">()</span><span class="o">.</span><span class="n">unique_hostnames</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hosts</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;available hosts:&quot;</span><span class="p">,</span><span class="n">hosts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">HostPool</span><span class="p">(</span><span class="n">hostlist</span><span class="o">=</span><span class="n">HostList</span><span class="p">([</span><span class="n">hosts</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span>
                            <span class="n">commandexecutor</span><span class="o">=</span><span class="n">SSHExecutor</span><span class="p">())</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">RandomFile</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;_var&quot;</span><span class="p">;</span> <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span> <span class="n">RandomID</span><span class="p">()</span> <span class="p">);</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s">&quot;testremotessh&quot;</span><span class="p">;</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">fn</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;echo $</span><span class="si">%s</span><span class="s"> &gt; </span><span class="si">%s</span><span class="s">; sleep 1&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">fn</span><span class="p">)),</span>
                      <span class="n">debug</span><span class="o">=</span><span class="s">&quot;task+exec+ssh&quot;</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">HostLocator</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">pool</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ClusterHasSharedFileSystem</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">outfile</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">();</span> <span class="k">print</span> <span class="s">&quot;&lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="n">line</span>
                            <span class="k">assert</span><span class="p">(</span><span class="n">line</span><span class="o">==</span><span class="n">val</span><span class="p">)</span>
                            <span class="k">break</span>
                <span class="k">except</span><span class="p">:</span> 
                    <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s">&quot;cat </span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pwd</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="n">hostread</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">();</span> <span class="k">print</span> <span class="n">hostread</span>
                <span class="k">assert</span><span class="p">(</span><span class="n">hostread</span><span class="o">==</span><span class="n">val</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/rm -f </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">testLeaveSSHOutput</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ndirs</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirs</span> <span class="o">=</span> <span class="p">[</span> <span class="n">RandomDir</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndirs</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">print</span> <span class="s">&quot;creating directories:&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">,</span><span class="s">&quot;in&quot;</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">:</span>
            <span class="n">absdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">d</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">absdir</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Problem running this test&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">absdir</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">absdir</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;creating&quot;</span><span class="p">,</span><span class="n">absdir</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">absdir</span><span class="p">)</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">Executor</span><span class="o">.</span><span class="n">default_workdir</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taccpool</span> <span class="o">=</span> <span class="n">DefaultHostPool</span><span class="p">(</span><span class="n">commandexecutor</span><span class="o">=</span><span class="n">SSHExecutor</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>            
    <span class="k">def</span> <span class="nf">testSSHLeaveResultAbsolute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testSSHLeaveResultAbsolute: create a file in a directory and detect that it&#39;s there&quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="s">&quot;curdir  :&quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span>
        <span class="k">print</span> <span class="s">&quot;available&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dirs</span>
        <span class="n">taskid</span> <span class="o">=</span> <span class="n">RandomID</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">RandomFile</span><span class="p">();</span> <span class="n">absdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">tmpdir</span>
        <span class="k">print</span> <span class="s">&quot;going to create </span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;cd </span><span class="si">%s</span><span class="s">; touch </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">absdir</span><span class="p">,</span><span class="n">tmpfile</span><span class="p">)),</span>
                  <span class="n">taskid</span><span class="o">=</span><span class="n">taskid</span><span class="p">,</span>
                  <span class="n">completion</span><span class="o">=</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">taskid</span><span class="p">),</span><span class="n">debug</span><span class="o">=</span><span class="s">&quot;task+exec+ssh&quot;</span><span class="p">)</span>
        <span class="n">nodepool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taccpool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">nodepool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">nodepool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taccpool</span><span class="o">.</span><span class="n">occupyNodes</span><span class="p">(</span><span class="n">nodepool</span><span class="p">,</span><span class="n">t</span><span class="o">.</span><span class="n">taskid</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">test</span><span class="p">())</span>
        <span class="k">print</span> <span class="s">&quot;stampdir:&quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">stampdir</span><span class="p">))</span>
        <span class="n">dircontent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">absdir</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;looking for result in &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt; and found &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="n">absdir</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dircontent</span><span class="p">))</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">tmpfile</span> <span class="ow">in</span> <span class="n">dircontent</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testSSHLeaveResultRelative</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testSSHLeaveResultRelative: create a file in a directory and detect that it&#39;s there&quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="s">&quot;curdir  :&quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span>
        <span class="k">print</span> <span class="s">&quot;available&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dirs</span>
        <span class="n">taskid</span> <span class="o">=</span> <span class="n">RandomID</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">RandomFile</span><span class="p">();</span> <span class="n">absdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">tmpdir</span>
        <span class="k">print</span> <span class="s">&quot;going to create </span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span> <span class="n">Commandline</span><span class="p">(</span><span class="s">&quot;cd </span><span class="si">%s</span><span class="s">; touch </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span><span class="n">tmpfile</span><span class="p">)),</span>
                  <span class="n">taskid</span><span class="o">=</span><span class="n">taskid</span><span class="p">,</span>
                  <span class="n">completion</span><span class="o">=</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">taskid</span><span class="p">),</span><span class="n">debug</span><span class="o">=</span><span class="s">&quot;task+exec+ssh&quot;</span><span class="p">)</span>
        <span class="n">nodepool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taccpool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">nodepool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">nodepool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taccpool</span><span class="o">.</span><span class="n">occupyNodes</span><span class="p">(</span><span class="n">nodepool</span><span class="p">,</span><span class="n">t</span><span class="o">.</span><span class="n">taskid</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">test</span><span class="p">())</span>
        <span class="k">print</span> <span class="s">&quot;stampdir:&quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">stampdir</span><span class="p">))</span>
        <span class="n">dircontent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">absdir</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;looking for result in &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt; and found &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="n">absdir</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dircontent</span><span class="p">))</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">tmpfile</span> <span class="ow">in</span> <span class="n">dircontent</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testLeaveModResultsImmediately</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testLeaveModResultsImmediately: Leave results in multiple directories&quot;&quot;&quot;</span>
        <span class="n">ntasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taccpool</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="n">TaskGenerator</span><span class="p">(</span> 
            <span class="p">[</span> <span class="s">&quot;cd </span><span class="si">%s</span><span class="s"> ; touch f</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">[</span> <span class="n">i</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">)</span> <span class="p">],</span><span class="n">i</span><span class="p">)</span> 
              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntasks</span><span class="p">)</span> <span class="p">],</span>
            <span class="p">)</span>
        <span class="n">collected</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">TaskGeneratorIterate</span><span class="p">(</span> <span class="n">tasks</span> <span class="p">):</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taccpool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">nodes</span><span class="p">)</span>
            <span class="n">collected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">collected</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">test</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">&gt;=</span><span class="nb">int</span><span class="p">(</span><span class="n">ntasks</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taccpool</span><span class="p">)))</span>
    <span class="k">def</span> <span class="nf">testLeaveModResultsWithTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testLeaveModResultsWithTest: Leave results in multiple directories with stamptest&quot;&quot;&quot;</span>
        <span class="n">ntasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taccpool</span><span class="p">)</span>
        <span class="c"># leave stamps in the first tmp directory</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="n">TaskGenerator</span><span class="p">(</span> 
            <span class="p">[</span> <span class="s">&quot;cd </span><span class="si">%s</span><span class="s"> ; touch f</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">[</span> <span class="n">i</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">)</span> <span class="p">],</span><span class="n">i</span><span class="p">)</span> 
              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntasks</span><span class="p">)</span> <span class="p">],</span>
            <span class="n">completion</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">stampdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="p">)</span>
        <span class="n">collected</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">TaskGeneratorIterate</span><span class="p">(</span> <span class="n">tasks</span> <span class="p">):</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taccpool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start_on_nodes</span><span class="p">(</span><span class="n">pool</span><span class="o">=</span><span class="n">nodes</span><span class="p">)</span>
            <span class="n">collected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">collected</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">test</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">&gt;=</span><span class="nb">int</span><span class="p">(</span><span class="n">ntasks</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">taccpool</span><span class="p">)))</span>
        <span class="n">content0</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="k">print</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">content0</span><span class="p">)</span>
        <span class="n">stamps</span> <span class="o">=</span> <span class="p">[</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">content0</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;expire&quot;</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stamps</span><span class="p">)</span><span class="o">==</span><span class="n">ntasks</span><span class="p">)</span>

<div class="viewcode-block" id="IbrunExecutor"><a class="viewcode-back" href="../implementation.html#pylauncher.IbrunExecutor">[docs]</a><span class="k">class</span> <span class="nc">IbrunExecutor</span><span class="p">(</span><span class="n">Executor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An Executor derived class for the shift/offset version of ibrun</span>
<span class="sd">    that is in use at TACC</span>

<span class="sd">    :param pool: (required) ``HostLocator`` object</span>
<span class="sd">    :param stdout: (optional) a file that is open for writing; by default ``subprocess.PIPE`` is used</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">catch_output</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;catch_output&quot;</span><span class="p">,</span><span class="s">&quot;foo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">catch_output</span><span class="o">!=</span><span class="s">&quot;foo&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;IbrunExecutor does not take catch_output parameter&quot;</span><span class="p">)</span>
        <span class="n">Executor</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">catch_output</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">popen_object</span> <span class="o">=</span> <span class="bp">None</span>
<div class="viewcode-block" id="IbrunExecutor.execute"><a class="viewcode-back" href="../implementation.html#pylauncher.IbrunExecutor.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Much like ``SSHExecutor.execute()``, except that it prefixes</span>
<span class="sd">        with ``ibrun -n -o``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;pool&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pool</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;SSHExecutor needs explicit HostPool&quot;</span><span class="p">)</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;stdout&quot;</span><span class="p">,</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">full_commandline</span> <span class="o">=</span>  <span class="s">&quot;ibrun -o </span><span class="si">%d</span><span class="s"> -n </span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="s"> &amp; &quot;</span> <span class="o">%</span> \
               <span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span><span class="n">pool</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;executed commandline: &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="n">full_commandline</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Exec&quot;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">full_commandline</span><span class="p">,</span>
                             <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">popen_object</span> <span class="o">=</span> <span class="n">p</span></div>
    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">popen_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">popen_object</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</div>
<span class="k">class</span> <span class="nc">testIbrunExecutor</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This creates and compiles a MPI program.</span>
<span class="sd">        The program outputs the hostname and the communicator size.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testprog_name</span> <span class="o">=</span> <span class="s">&quot;pylauncher_tmp_prog_print_comm_size&quot;</span>
        <span class="n">testprog</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testprog_name</span><span class="o">+</span><span class="s">&quot;.c&quot;</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">testprog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">#include &lt;stdlib.h&gt;</span>
<span class="s">#include &lt;stdio.h&gt;</span>
<span class="s">#include &quot;mpi.h&quot;</span>
<span class="s">int main(int argc,char **argv) {</span>
<span class="s">  int mytid,ntids;</span>
<span class="s">  MPI_Init(&amp;argc,&amp;argv);</span>
<span class="s">  MPI_Comm_rank(MPI_COMM_WORLD,&amp;mytid);</span>
<span class="s">  MPI_Comm_size(MPI_COMM_WORLD,&amp;ntids);</span>
<span class="s">  if (mytid==0) printf(&quot;TACC PyLauncher comm size detection running</span><span class="se">\\</span><span class="s">n&quot;);</span>
<span class="s">  if (mytid==0) system(&quot;hostname -f&quot;);</span>
<span class="s">  if (mytid==0) printf(&quot;</span><span class="si">%d</span><span class="se">\\</span><span class="s">n&quot;,ntids);</span>
<span class="s">  MPI_Finalize();</span>
<span class="s">  return 0;</span>
<span class="s">}</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">testprog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;mpicc -o </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">.c&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testprog_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">testprog_name</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/rm -rf </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">Executor</span><span class="o">.</span><span class="n">default_workdir</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testIbrunNodeOccupy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testIbrunNodeOccupy: put two parallel tests on the host pool;</span>
<span class="sd">        one each on half of the pool.&quot;&quot;&quot;</span>
        <span class="n">ibrun_executor</span> <span class="o">=</span> <span class="n">IbrunExecutor</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="s">&quot;exec&quot;</span><span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">DefaultHostPool</span><span class="p">(</span><span class="n">commandexecutor</span><span class="o">=</span><span class="n">ibrun_executor</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;That&#39;s odd!&quot;</span><span class="p">)</span>
        <span class="n">nnodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">nslp</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="c"># put a task on half the nodes</span>
        <span class="n">line1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">testprog_name</span>
        <span class="n">nodes1</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="n">nnodes</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;line1:&quot;</span><span class="p">,</span> <span class="n">line1</span>
        <span class="n">out1</span> <span class="o">=</span> <span class="n">RandomFile</span><span class="p">();</span> <span class="n">out_handle1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out1</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">ibrun_executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">line1</span><span class="p">,</span><span class="n">pool</span><span class="o">=</span><span class="n">nodes1</span><span class="p">,</span><span class="n">stdout</span><span class="o">=</span><span class="n">out_handle1</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">occupyNodes</span><span class="p">(</span><span class="n">nodes1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># put a task on the other half of the nodes</span>
        <span class="n">line2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">testprog_name</span>
        <span class="n">nodes2</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="n">nnodes</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;line2:&quot;</span><span class="p">,</span> <span class="n">line2</span>
        <span class="n">out2</span> <span class="o">=</span> <span class="n">RandomFile</span><span class="p">();</span> <span class="n">out_handle2</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out2</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">ibrun_executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">line2</span><span class="p">,</span><span class="n">pool</span><span class="o">=</span><span class="n">nodes2</span><span class="p">,</span><span class="n">stdout</span><span class="o">=</span><span class="n">out_handle2</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">occupyNodes</span><span class="p">(</span><span class="n">nodes2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="c"># there should be no nodes left</span>
        <span class="n">no_nodes</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">request_nodes</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="k">print</span> <span class="n">no_nodes</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">no_nodes</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>
        <span class="c"># see if the result was left</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">nslp</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out1</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out1</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output1</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output1</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">print</span> <span class="s">&quot;output1:&quot;</span><span class="p">,</span><span class="n">line</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;TACC&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">):</span> <span class="k">continue</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">hostname1</span> <span class="o">=</span> <span class="n">line</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="k">assert</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">==</span><span class="n">nnodes</span><span class="p">)</span>                
                <span class="k">break</span>
        <span class="k">assert</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out2</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out2</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output2</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output2</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">print</span> <span class="s">&quot;output2:&quot;</span><span class="p">,</span><span class="n">line</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;TACC&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">):</span> <span class="k">continue</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">hostname2</span> <span class="o">=</span> <span class="n">line</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="k">assert</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">==</span><span class="n">nnodes</span><span class="p">)</span>                
                <span class="k">break</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">unique_hostnames</span><span class="p">())</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">hostname1</span><span class="o">!=</span><span class="n">hostname2</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="c"># see what&#39;s running</span>
        <span class="c"># host1 = nodes1.firsthost()</span>
        <span class="c"># host2 = nodes2.firsthost()</span>
        <span class="c"># ssh1 = ssh_client(host1)</span>
        <span class="c"># ssh2 = ssh_client(host2)</span>


<div class="viewcode-block" id="LauncherJob"><a class="viewcode-back" href="../trace.html#pylauncher.LauncherJob">[docs]</a><span class="k">class</span> <span class="nc">LauncherJob</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;LauncherJob class. Keyword arguments:</span>

<span class="sd">    :param hostpool: a HostPool instance (required)</span>
<span class="sd">    :param taskgenerator: a TaskGenerator instance (required)</span>
<span class="sd">    :param delay: between task checks  (optional)</span>
<span class="sd">    :param debug: list of keywords (optional)</span>
<span class="sd">    :param gather_output: (keyword, optional, default None) filename to gather all command output</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;hostpool&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Need a host pool&quot;</span><span class="p">)</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;Host pool: &lt;&lt;</span><span class="si">%s</span><span class="s">&gt;&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">),</span>
                      <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;host&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debugs</span><span class="p">),</span><span class="s">&quot;Job&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskgenerator</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;taskgenerator&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskgenerator</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Need a task generator&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;delay&quot;</span><span class="p">,</span><span class="o">.</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">TaskQueue</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debugs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxruntime</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;maxruntime&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;job&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debugs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">tock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">barriertest</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gather_output</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;gather_output&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Unprocessed LauncherJob args: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">finish_or_continue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># auxiliary routine, purely to make ``tick`` look shorter</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Done before we started....&quot;</span><span class="p">)</span>
            <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;Generator and tasks finished&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Job&quot;</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;finished&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;Generator finished; tasks still running&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Job&quot;</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;continuing&quot;</span>
        <span class="k">return</span> <span class="n">message</span>
    <span class="k">def</span> <span class="nf">enqueue_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">task</span><span class="p">):</span>
        <span class="c"># auxiliary routine, purely to make ``tick`` look shorter</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,(</span><span class="n">Task</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="s">&quot;Not a task: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;enqueueing new task &lt;</span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Job&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<div class="viewcode-block" id="LauncherJob.tick"><a class="viewcode-back" href="../implementation.html#pylauncher.LauncherJob.tick">[docs]</a>    <span class="k">def</span> <span class="nf">tick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This routine does a single time step in a launcher&#39;s life, and reports back</span>
<span class="sd">        to the user. Specifically:</span>

<span class="sd">        * It tries to start any currently queued jobs. Also:</span>
<span class="sd">        * If any jobs are finished, it detects exactly one, and reports its ID to the user in a message ``expired 123``</span>
<span class="sd">        * If there are no finished jobs, it invokes the task generator; this can result in a new task and the return message is ``continuing``</span>
<span class="sd">        * if the generator stalls, that is, more tasks will come in the future but none are available now, the message is ``stalling``</span>
<span class="sd">        * if the generator is finished and all jobs have finished, the message is ``finished``</span>

<span class="sd">        After invoking the task generator, a short sleep is inserted (see the ``delay`` parameter)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">tick </span><span class="si">%d</span><span class="se">\n</span><span class="s">Queue:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tock</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)),</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tock</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c"># see if the barrier test is completely satisfied</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">barriertest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">reduce</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">y</span><span class="p">,</span>
                       <span class="p">[</span> <span class="n">t</span><span class="o">.</span><span class="n">completed</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">barriertest</span> <span class="p">]</span> <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">barriertest</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;continuing&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># if the barrier still stands, stall</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;stalling&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># if the barrier is resolved, queue and test and whatnot</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">startQueued</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">)</span>
            <span class="n">completed_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">find_recently_completed</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">completed_task</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">completed_task</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">completed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">completed_task</span><span class="p">)</span>
                <span class="n">completeID</span> <span class="o">=</span> <span class="n">completed_task</span><span class="o">.</span><span class="n">taskid</span>
                <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;completed: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">completeID</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Job&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">completed</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="o">.</span><span class="n">releaseNodesByTask</span><span class="p">(</span><span class="n">completeID</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;expired </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">completeID</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskgenerator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">task</span><span class="o">==</span><span class="n">pylauncherBarrierString</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;stalling&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">barriertest</span> <span class="o">=</span> <span class="p">[</span> <span class="n">t</span><span class="o">.</span><span class="n">completion</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">running</span> <span class="p">]</span>
                        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;barrier encountered&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Job&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">task</span><span class="o">==</span><span class="s">&quot;stall&quot;</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;stalling&quot;</span>
                        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;stalling&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Job&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">enqueue_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;enqueueing&quot;</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finish_or_continue</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">message</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;stalling&quot;</span><span class="p">,</span><span class="s">&quot;continuing&quot;</span><span class="p">]:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;host&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debugs</span><span class="p">):</span>
            <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">))</span>
        <span class="n">DebugTraceMsg</span><span class="p">(</span><span class="s">&quot;status: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;Job&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">message</span></div>
<div class="viewcode-block" id="LauncherJob.run"><a class="viewcode-back" href="../implementation.html#pylauncher.LauncherJob.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invoke the launcher job, and call ``tick`` until all jobs are finished.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;host&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">debugs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="o">.</span><span class="n">printhosts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">==</span><span class="s">&quot;finished&quot;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxruntime</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">starttime</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">maxruntime</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">starttime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span></div>
    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
<div class="viewcode-block" id="LauncherJob.final_report"><a class="viewcode-back" href="../trace.html#pylauncher.LauncherJob.final_report">[docs]</a>    <span class="k">def</span> <span class="nf">final_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string describing the total running time, as well as</span>
<span class="sd">        including the final report from the embedded ``HostPool`` and ``TaskQueue``</span>
<span class="sd">        objects.&quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">==========================</span>
<span class="s">Launcherjob run completed.</span>

<span class="s">total running time: </span><span class="si">%6.2f</span><span class="s"></span>

<span class="si">%s</span><span class="s"></span>

<span class="si">%s</span><span class="s"></span>
<span class="s">==========================</span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">runningtime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">final_report</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="o">.</span><span class="n">final_report</span><span class="p">()</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">message</span>

</div></div>
<span class="k">class</span> <span class="nc">TestLocalLauncherJobs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Tests of the LauncherJob class through the LocalExecutor,</span>
<span class="sd">    which is the default for the HostPool class&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">removecommandfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;rm -f </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launcherdir</span> <span class="o">=</span> <span class="n">RandomDir</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">makecommandfile</span><span class="p">()</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">Executor</span><span class="o">.</span><span class="n">default_workdir</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span> <span class="o">=</span> <span class="n">LocalHostPool</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">makecommandfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;make a commandlines file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="s">&quot;unittestlines&quot;</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsleep</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">MakeRandomSleepFile</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">,</span><span class="n">tmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maxsleep</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">icommand</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
    <span class="k">def</span> <span class="nf">testLocalFileTaskJob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testLocalFileTaskJob: test instantaneously finished jobs on a local hostpool&quot;&quot;&quot;</span>
        <span class="n">ntasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">LauncherJob</span><span class="p">(</span> 
            <span class="n">taskgenerator</span><span class="o">=</span><span class="n">TaskGenerator</span><span class="p">(</span> <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="p">),</span>
            <span class="n">hostpool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">,</span> <span class="n">delay</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="s">&quot;queue,job&quot;</span>
            <span class="p">)</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">starttime</span>
            <span class="k">print</span> <span class="s">&quot;tick:&quot;</span><span class="p">,</span><span class="n">job</span><span class="o">.</span><span class="n">tock</span><span class="p">,</span><span class="s">&quot;elapsed: </span><span class="si">%5.3e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">elapsed</span><span class="p">,</span><span class="s">&quot;result:&quot;</span><span class="p">,</span><span class="n">res</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">==</span><span class="s">&quot;finished&quot;</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^expire&quot;</span><span class="p">,</span><span class="n">res</span><span class="p">):</span>
                <span class="k">print</span> <span class="n">res</span>
            <span class="k">if</span> <span class="n">elapsed</span><span class="o">&gt;</span><span class="mi">2</span><span class="o">+</span><span class="n">ntasks</span><span class="o">*</span><span class="n">job</span><span class="o">.</span><span class="n">delay</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxsleep</span><span class="p">:</span>
                <span class="n">estr</span> <span class="o">=</span> <span class="s">&quot;This is taking too long: </span><span class="si">%d</span><span class="s"> sec for </span><span class="si">%d</span><span class="s"> tasks&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">elapsed</span><span class="p">),</span><span class="n">ntasks</span><span class="p">)</span>
                <span class="k">print</span> <span class="n">estr</span>
                <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="n">estr</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testLocalFileTaskJobCustom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testLocalFileTaskJobCustom: test jobs with file completion on a local pool&quot;&quot;&quot;</span>
        <span class="n">ntasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">LauncherJob</span><span class="p">(</span> 
            <span class="n">taskgenerator</span><span class="o">=</span><span class="n">TaskGenerator</span><span class="p">(</span> <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                      <span class="n">completion</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                                            <span class="n">stampdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">launcherdir</span><span class="p">,</span><span class="n">stamproot</span><span class="o">=</span><span class="s">&quot;expire&quot;</span><span class="p">)</span> <span class="p">),</span>
            <span class="n">hostpool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="s">&quot;queue,job&quot;</span>
            <span class="p">)</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
            <span class="k">assert</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">launcherdir</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">starttime</span>
            <span class="k">print</span> <span class="s">&quot;tick:&quot;</span><span class="p">,</span><span class="n">job</span><span class="o">.</span><span class="n">tock</span><span class="p">,</span><span class="s">&quot;elapsed: </span><span class="si">%5.3e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">elapsed</span><span class="p">,</span><span class="s">&quot;result:&quot;</span><span class="p">,</span><span class="n">res</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">==</span><span class="s">&quot;finished&quot;</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^expire&quot;</span><span class="p">,</span><span class="n">res</span><span class="p">):</span>
                <span class="k">print</span> <span class="n">res</span>
            <span class="k">if</span> <span class="n">elapsed</span><span class="o">&gt;</span><span class="mi">2</span><span class="o">+</span><span class="n">ntasks</span><span class="o">*</span><span class="n">job</span><span class="o">.</span><span class="n">delay</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxsleep</span><span class="p">:</span>
                <span class="n">estr</span> <span class="o">=</span> <span class="s">&quot;This is taking too long: </span><span class="si">%d</span><span class="s"> sec for </span><span class="si">%d</span><span class="s"> tasks&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">elapsed</span><span class="p">),</span><span class="n">ntasks</span><span class="p">)</span>
                <span class="k">print</span> <span class="n">estr</span>
                <span class="k">raise</span> <span class="n">LauncherException</span><span class="p">(</span><span class="n">estr</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TestSSHLauncherJobs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Tests of the LauncherJob class through the SSHExecutor&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">removecommandfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;rm -f </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">makecommandfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ncommand</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;make a commandlines file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="s">&quot;unittestlines&quot;</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span> <span class="o">=</span> <span class="n">ncommand</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsleep</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">MakeRandomSleepFile</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">,</span><span class="n">tmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maxsleep</span><span class="p">,</span>
                             <span class="n">cores</span><span class="o">=</span><span class="n">cores</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">icommand</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launcherdir</span> <span class="o">=</span> <span class="s">&quot;testlauncherjobs.tmp&quot;</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">Executor</span><span class="o">.</span><span class="n">default_workdir</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span> <span class="o">=</span> <span class="n">DefaultHostPool</span><span class="p">(</span><span class="n">commandexecutor</span><span class="o">=</span><span class="n">SSHExecutor</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span> <span class="s">&quot;/bin/rm -rf </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">launcherdir</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removecommandfile</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">testSSHFileTaskJob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testSSHFileTaskJob: test ssh&#39;ing on an actual host pool&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">makecommandfile</span><span class="p">()</span>
        <span class="n">ntasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span>
        <span class="k">if</span> <span class="n">ntasks</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">):</span> <span class="c"># make sure we can run without delay</span>
            <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">);</span> <span class="k">return</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">LauncherJob</span><span class="p">(</span> 
            <span class="n">taskgenerator</span><span class="o">=</span><span class="n">TaskGenerator</span><span class="p">(</span> <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                      <span class="n">completion</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">stampdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">launcherdir</span><span class="p">)</span> <span class="p">),</span>
            <span class="n">hostpool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">,</span>
            <span class="n">delay</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="s">&quot;queue,job&quot;</span>
            <span class="p">)</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">starttime</span>
            <span class="k">print</span> <span class="s">&quot;tick:&quot;</span><span class="p">,</span><span class="n">job</span><span class="o">.</span><span class="n">tock</span><span class="p">,</span><span class="s">&quot;elapsed: </span><span class="si">%5.3e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">elapsed</span><span class="p">,</span><span class="s">&quot;result:&quot;</span><span class="p">,</span><span class="n">res</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">==</span><span class="s">&quot;finished&quot;</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^expire&quot;</span><span class="p">,</span><span class="n">res</span><span class="p">):</span>
                <span class="k">print</span> <span class="n">res</span>
            <span class="k">if</span> <span class="n">elapsed</span><span class="o">&gt;</span><span class="mi">2</span><span class="o">+</span><span class="n">ntasks</span><span class="o">*</span><span class="n">job</span><span class="o">.</span><span class="n">delay</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxsleep</span><span class="p">:</span>
                <span class="n">estr</span> <span class="o">=</span> <span class="s">&quot;This is taking too long: </span><span class="si">%d</span><span class="s"> sec for </span><span class="si">%d</span><span class="s"> tasks&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">elapsed</span><span class="p">),</span><span class="n">ntasks</span><span class="p">)</span>
                <span class="k">print</span> <span class="n">estr</span>
                <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testLauncherJobRun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testLauncherJobRun: test with ssh&#39;ing, and just let it run&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">makecommandfile</span><span class="p">()</span>
        <span class="n">ntasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">;</span> <span class="n">delay</span> <span class="o">=</span> <span class="o">.</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">ntasks</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">):</span> <span class="c"># make sure we can run without delay</span>
            <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">);</span> <span class="k">return</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">LauncherJob</span><span class="p">(</span> 
            <span class="n">taskgenerator</span><span class="o">=</span><span class="n">TaskGenerator</span><span class="p">(</span> <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                              <span class="n">completion</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">stampdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">launcherdir</span><span class="p">)</span> <span class="p">),</span>
            <span class="n">hostpool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">,</span>
            <span class="n">delay</span><span class="o">=</span><span class="n">delay</span><span class="p">,</span><span class="n">maxruntime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maxsleep</span><span class="o">+</span><span class="n">ntasks</span><span class="o">*</span><span class="n">delay</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="s">&quot;queue,job&quot;</span>
            <span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testMulticoreTaskGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testMulticoreTaskGenerator: This is preliminary to the next test&quot;&quot;&quot;</span>
        <span class="n">ncores</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">makecommandfile</span><span class="p">(</span><span class="n">cores</span><span class="o">=</span><span class="n">ncores</span><span class="p">)</span>
        <span class="n">ntasks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="o">/</span><span class="n">ncores</span> <span class="p">);</span> <span class="n">delay</span> <span class="o">=</span> <span class="o">.</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">ntasks</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">)</span><span class="o">/</span><span class="n">ncores</span><span class="p">:</span> <span class="c"># make sure we can run without delay</span>
            <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">);</span> <span class="k">return</span>
        <span class="n">generator</span><span class="o">=</span><span class="n">TaskGenerator</span><span class="p">(</span> <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="n">ncores</span><span class="p">),</span>
                    <span class="n">completion</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">stampdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">launcherdir</span><span class="p">),</span>
                                 <span class="n">debug</span><span class="o">=</span><span class="s">&quot;task&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">generator</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;stall&quot;</span><span class="p">,</span><span class="s">&quot;stop&quot;</span><span class="p">]:</span>
                <span class="k">break</span>
            <span class="k">assert</span><span class="p">(</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="n">ncores</span> <span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testMulticoreLauncherJobRun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testMulticoreLauncherJobRun: test with ssh&#39;ing, and just let it run&quot;&quot;&quot;</span>
        <span class="n">ncores</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">makecommandfile</span><span class="p">(</span><span class="n">cores</span><span class="o">=</span><span class="n">ncores</span><span class="p">)</span>
        <span class="n">ntasks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="o">/</span><span class="n">ncores</span> <span class="p">);</span> <span class="n">delay</span> <span class="o">=</span> <span class="o">.</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">ntasks</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">)</span><span class="o">/</span><span class="n">ncores</span><span class="p">:</span> <span class="c"># make sure we can run without delay</span>
            <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">);</span> <span class="k">return</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">LauncherJob</span><span class="p">(</span> 
            <span class="n">taskgenerator</span><span class="o">=</span><span class="n">TaskGenerator</span><span class="p">(</span> <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="n">ncores</span><span class="p">),</span>
                              <span class="n">completion</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">stampdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">launcherdir</span><span class="p">),</span>
                                         <span class="n">debug</span><span class="o">=</span><span class="s">&quot;task&quot;</span><span class="p">),</span>
            <span class="n">hostpool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">,</span>
            <span class="n">delay</span><span class="o">=</span><span class="n">delay</span><span class="p">,</span><span class="n">maxruntime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maxsleep</span><span class="o">+</span><span class="n">ntasks</span><span class="o">*</span><span class="n">delay</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="s">&quot;queue,job&quot;</span>
            <span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testLauncherJobRunWithWait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ntasks</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">);</span> <span class="n">delay</span> <span class="o">=</span> <span class="o">.</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">makecommandfile</span><span class="p">(</span><span class="n">ncommand</span><span class="o">=</span><span class="n">ntasks</span><span class="p">)</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">LauncherJob</span><span class="p">(</span> 
            <span class="n">taskgenerator</span><span class="o">=</span><span class="n">TaskGenerator</span><span class="p">(</span> <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                      <span class="n">completion</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">stampdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">launcherdir</span><span class="p">)</span> <span class="p">),</span>
            <span class="n">hostpool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">,</span>
            <span class="n">delay</span><span class="o">=</span><span class="n">delay</span><span class="p">,</span><span class="n">maxruntime</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">maxsleep</span><span class="o">+</span><span class="n">ntasks</span><span class="o">*</span><span class="n">delay</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="s">&quot;queue,job&quot;</span>
            <span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;tasks completed </span><span class="si">%d</span><span class="s"> s/b </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">completed</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">completed</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">testIBRUNLauncherJobs</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launcherdir</span> <span class="o">=</span> <span class="n">NoRandomDir</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span> <span class="o">=</span> <span class="n">HostPool</span><span class="p">(</span> <span class="n">hostlist</span><span class="o">=</span><span class="n">HostListByName</span><span class="p">(),</span>
                 <span class="n">commandexecutor</span><span class="o">=</span><span class="n">IbrunExecutor</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">launcherdir</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="s">&quot;exec,ssh&quot;</span><span class="p">),</span>
                                  <span class="n">debug</span><span class="o">=</span><span class="s">&quot;host,task&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">makecommandfile</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">makecommandfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;make a commandlines file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">RandomFile</span><span class="p">(</span><span class="s">&quot;ibruntest&quot;</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxsleep</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outfile</span> <span class="o">=</span> <span class="n">RandomFile</span><span class="p">(</span><span class="s">&quot;ibruntest-out&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;rm -f </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">outfile</span><span class="p">)</span> <span class="p">)</span>
        <span class="c">#MakeRandomSleepFile( self.fn,self.ncommand,tmax=self.maxsleep )</span>
        <span class="n">MakeRandomCommandFile</span>\
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">,</span>
             <span class="n">generator</span><span class="o">=</span><span class="n">CountedCommandGenerator</span><span class="p">(</span>
                    <span class="n">command</span><span class="o">=</span><span class="s">&quot;/bin/true&quot;</span><span class="p">,</span><span class="n">nmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">)</span> <span class="c">#,catch=self.outfile))</span>
             <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">icommand</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
    <span class="k">def</span> <span class="nf">testIbrunFileTaskJobSingle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testIbrunFileTaskJobSingle: test ssh&#39;ing on an actual host pool&quot;&quot;&quot;</span>
        <span class="n">ntasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span>
        <span class="k">if</span> <span class="mi">2</span><span class="o">*</span><span class="n">ntasks</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">):</span> <span class="c"># make sure we can run without delay</span>
            <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">);</span> <span class="k">return</span> 
        <span class="n">job</span> <span class="o">=</span> <span class="n">LauncherJob</span><span class="p">(</span> 
            <span class="n">taskgenerator</span><span class="o">=</span><span class="n">TaskGenerator</span><span class="p">(</span> <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                 <span class="n">completion</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">stampdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">launcherdir</span><span class="p">),</span>
                                         <span class="n">debug</span><span class="o">=</span><span class="s">&quot;task&quot;</span><span class="p">),</span>
            <span class="n">hostpool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">,</span><span class="n">delay</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="s">&quot;queue,job,task,exec&quot;</span>
            <span class="p">)</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">starttime</span>
            <span class="k">print</span> <span class="s">&quot;tick:&quot;</span><span class="p">,</span><span class="n">job</span><span class="o">.</span><span class="n">tock</span><span class="p">,</span><span class="s">&quot;elapsed: </span><span class="si">%5.3e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">elapsed</span><span class="p">,</span><span class="s">&quot;result:&quot;</span><span class="p">,</span><span class="n">res</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">==</span><span class="s">&quot;finished&quot;</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^expire&quot;</span><span class="p">,</span><span class="n">res</span><span class="p">):</span>
                <span class="k">print</span> <span class="n">res</span>
            <span class="k">if</span> <span class="n">elapsed</span><span class="o">&gt;</span><span class="mi">2</span><span class="o">+</span><span class="n">ntasks</span><span class="o">*</span><span class="n">job</span><span class="o">.</span><span class="n">delay</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxsleep</span><span class="p">:</span>
                <span class="n">estr</span> <span class="o">=</span> <span class="s">&quot;This is taking too long: </span><span class="si">%d</span><span class="s"> sec for </span><span class="si">%d</span><span class="s"> tasks&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">elapsed</span><span class="p">),</span><span class="n">ntasks</span><span class="p">)</span>
                <span class="k">print</span> <span class="n">estr</span>
                <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testIbrunFileTaskJob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testIbrunFileTaskJob: test ssh&#39;ing on an actual host pool&quot;&quot;&quot;</span>
        <span class="n">ntasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span>
        <span class="k">if</span> <span class="mi">2</span><span class="o">*</span><span class="n">ntasks</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">):</span> <span class="c"># make sure we can run without delay</span>
            <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">);</span> <span class="k">return</span> 
        <span class="n">job</span> <span class="o">=</span> <span class="n">LauncherJob</span><span class="p">(</span> 
            <span class="n">taskgenerator</span><span class="o">=</span><span class="n">TaskGenerator</span><span class="p">(</span> <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                      <span class="n">completion</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">stampdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">launcherdir</span><span class="p">)</span> <span class="p">),</span>
            <span class="n">hostpool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">,</span><span class="n">delay</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="s">&quot;queue,job&quot;</span>
            <span class="p">)</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">starttime</span>
            <span class="k">print</span> <span class="s">&quot;tick:&quot;</span><span class="p">,</span><span class="n">job</span><span class="o">.</span><span class="n">tock</span><span class="p">,</span><span class="s">&quot;elapsed: </span><span class="si">%5.3e</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">elapsed</span><span class="p">,</span><span class="s">&quot;result:&quot;</span><span class="p">,</span><span class="n">res</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">==</span><span class="s">&quot;finished&quot;</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;^expire&quot;</span><span class="p">,</span><span class="n">res</span><span class="p">):</span>
                <span class="k">print</span> <span class="n">res</span>
            <span class="k">if</span> <span class="n">elapsed</span><span class="o">&gt;</span><span class="mi">2</span><span class="o">+</span><span class="n">ntasks</span><span class="o">*</span><span class="n">job</span><span class="o">.</span><span class="n">delay</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxsleep</span><span class="p">:</span>
                <span class="n">estr</span> <span class="o">=</span> <span class="s">&quot;This is taking too long: </span><span class="si">%d</span><span class="s"> sec for </span><span class="si">%d</span><span class="s"> tasks&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">elapsed</span><span class="p">),</span><span class="n">ntasks</span><span class="p">)</span>
                <span class="k">print</span> <span class="n">estr</span>
                <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testLauncherJobIbRun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;testLauncherJobIbRun: test with ssh&#39;ing, and just let it run&quot;&quot;&quot;</span>
        <span class="n">ntasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncommand</span><span class="p">;</span> <span class="n">delay</span> <span class="o">=</span> <span class="o">.</span><span class="mi">2</span>
        <span class="k">if</span> <span class="mi">2</span><span class="o">*</span><span class="n">ntasks</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">):</span> <span class="c"># make sure we can run without delay</span>
            <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">);</span> <span class="k">return</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">LauncherJob</span><span class="p">(</span> 
            <span class="n">taskgenerator</span><span class="o">=</span><span class="n">TaskGenerator</span><span class="p">(</span> <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                      <span class="n">completion</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">stampdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">launcherdir</span><span class="p">)</span> <span class="p">),</span>
            <span class="n">hostpool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hostpool</span><span class="p">,</span>
            <span class="n">delay</span><span class="o">=</span><span class="n">delay</span><span class="p">,</span><span class="n">maxruntime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maxsleep</span><span class="o">+</span><span class="n">ntasks</span><span class="o">*</span><span class="n">delay</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="s">&quot;queue,job&quot;</span>
            <span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">testChDir</span><span class="p">():</span>
    <span class="n">tmpdir</span> <span class="o">=</span> <span class="s">&quot;pylauncher_tmpdir_test</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">RandomID</span><span class="p">();</span> <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">RandomFile</span><span class="p">()</span>
    <span class="n">abs_tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">tmpdir</span><span class="p">;</span> <span class="k">print</span> <span class="s">&quot;working dir:&quot;</span><span class="p">,</span><span class="n">abs_tmpdir</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;rm -rf </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">abs_tmpdir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;mkdir -p </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">abs_tmpdir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">LauncherJob</span><span class="p">(</span> 
      <span class="n">hostpool</span><span class="o">=</span><span class="n">LocalHostPool</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="s">&quot;exec&quot;</span><span class="p">),</span>
      <span class="n">taskgenerator</span><span class="o">=</span><span class="n">TaskGenerator</span><span class="p">(</span> 
            <span class="n">ListCommandlineGenerator</span><span class="p">(</span><span class="nb">list</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;pwd ; echo foo ; echo bar &gt; </span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">tmpfile</span> <span class="p">]),</span>
            <span class="n">debug</span><span class="o">=</span><span class="s">&quot;task&quot;</span><span class="p">,</span>
            <span class="p">),</span>
      <span class="n">debug</span><span class="o">=</span><span class="s">&quot;task+queue+exec&quot;</span><span class="p">)</span>
    <span class="n">job</span><span class="o">.</span><span class="n">run</span><span class="p">();</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dircontent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span> <span class="k">print</span> <span class="s">&quot;. :&quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dircontent</span><span class="p">)</span>
    <span class="n">dircontent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">&quot;..&quot;</span><span class="p">);</span> <span class="k">print</span> <span class="s">&quot;.. :&quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dircontent</span><span class="p">)</span>
    <span class="n">dircontent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">abs_tmpdir</span><span class="p">);</span> <span class="k">print</span> <span class="n">abs_tmpdir</span><span class="p">,</span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dircontent</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">tmpfile</span> <span class="ow">in</span> <span class="n">dircontent</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;rm -rf </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">abs_tmpdir</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">testParamJob</span><span class="p">():</span>
    <span class="c"># first make a C program that parses argument</span>
    <span class="n">testprog_name</span> <span class="o">=</span> <span class="s">&quot;pylauncher_tmp_prog_print_id&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">testprog_name</span><span class="o">+</span><span class="s">&quot;.c&quot;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">testprog</span><span class="p">:</span>
        <span class="n">testprog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">#include &lt;stdlib.h&gt;</span>
<span class="s">#include &lt;stdio.h&gt;</span>
<span class="s">int main(int argc,char **argv) {</span>
<span class="s">  int id = atoi(argv[0]);</span>
<span class="s">  printf(</span><span class="se">\&quot;</span><span class="s">id: </span><span class="si">%d</span><span class="se">\\</span><span class="s">n</span><span class="se">\&quot;</span><span class="s">,id);</span>
<span class="s">  return 0;</span>
<span class="s">}</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;mpicc -o </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">.c&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">testprog_name</span><span class="p">,</span><span class="n">testprog_name</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/rm -rf </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">Executor</span><span class="o">.</span><span class="n">default_workdir</span><span class="p">)</span>
    <span class="c">#</span>
    <span class="c"># fn = RandomFile(); ntask = 10</span>
    <span class="c"># with open(fn,&quot;w&quot;) as commandfile:</span>
    <span class="c">#     for i in range(ntask):</span>
    <span class="c">#         commandfile.write(&quot;./%s PYLID\n&quot; % testprog_name)</span>
    <span class="c"># FileCommandlineGenerator(testprog)</span>
    <span class="c"># os.system(&quot;rm -f %s&quot; % testprog_name)</span>
    <span class="n">ntasks</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">catchfile</span> <span class="o">=</span> <span class="n">RandomFile</span><span class="p">()</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">LauncherJob</span><span class="p">(</span> 
      <span class="n">hostpool</span><span class="o">=</span><span class="n">LocalHostPool</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="s">&quot;exec&quot;</span><span class="p">),</span>
      <span class="n">taskgenerator</span><span class="o">=</span><span class="n">TaskGenerator</span><span class="p">(</span> 
            <span class="n">ListCommandlineGenerator</span><span class="p">(</span>
                <span class="nb">list</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;./</span><span class="si">%s</span><span class="s"> PYLID&quot;</span> <span class="o">%</span> <span class="n">testprog_name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntasks</span><span class="p">)</span> <span class="p">]),</span>
            <span class="n">debug</span><span class="o">=</span><span class="s">&quot;task&quot;</span><span class="p">,</span>
            <span class="p">),</span>
      <span class="n">gather_output</span><span class="o">=</span><span class="n">catchfile</span><span class="p">,</span>
      <span class="n">debug</span><span class="o">=</span><span class="s">&quot;task+queue+exec&quot;</span><span class="p">)</span>
    <span class="n">job</span><span class="o">.</span><span class="n">run</span><span class="p">();</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

<span class="c"># def testDependencies():</span>
<span class="c">#     ntasks = 4; nsleep = 4</span>
<span class="c">#     launcherdir = RandomDir(); os.system(&quot;/bin/rm -rf %s&quot; % launcherdir)</span>
<span class="c">#     hostpool = LocalHostPool(</span>
<span class="c">#         n=2*ntasks,workdir=launcherdir,force_workdir=True)</span>
<span class="c">#     fn = RandomFile(); comms = SleepCommandGenerator(tmin=nsleep,tmax=nsleep)</span>
<span class="c">#     commandfile = open( fn, &quot;w&quot;)</span>
<span class="c">#     for i in range(ntasks):</span>
<span class="c">#         commandfile.write( &quot;1,%d,%s\n&quot; % (i,comms.next()) )</span>
<span class="c">#     commandfile.write( &quot;1,%d-%d:%d,%s&quot; % \</span>
<span class="c">#               ( ntasks,0,ntasks,</span>
<span class="c">#                 comms.next() ) )</span>
<span class="c">#     commandfile.close()</span>
<span class="c">#     os.system(&quot;cat %s&quot; % fn)</span>
<span class="c">#     tstart = time.time()</span>
<span class="c">#     job = LauncherJob( hostpool=hostpool,</span>
<span class="c">#       taskgenerator=TaskGenerator( </span>
<span class="c">#             FileCommandlineGenerator( fn,cores=&quot;file&quot;,dependencies=True ),</span>
<span class="c">#             debug=&quot;task&quot;,</span>
<span class="c">#             ),</span>
<span class="c">#       debug=&quot;task+queue+exec&quot;)</span>
<span class="c">#     job.run()</span>
<span class="c">#     runtime = time.time()-tstart; print nsleep,runtime</span>
<span class="c">#     assert(runtime&gt;2*nsleep)</span>

<div class="viewcode-block" id="ClassicLauncher"><a class="viewcode-back" href="../extend.html#pylauncher.ClassicLauncher">[docs]</a><span class="k">def</span> <span class="nf">ClassicLauncher</span><span class="p">(</span><span class="n">commandfile</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A LauncherJob for a file of single or multi-threaded commands.</span>

<span class="sd">    The following values are specified for your convenience:</span>

<span class="sd">    * hostpool : based on HostListByName</span>
<span class="sd">    * commandexecutor : SSHExecutor</span>
<span class="sd">    * taskgenerator : based on the ``commandfile`` argument</span>
<span class="sd">    * completion : based on a directory ``pylauncher_tmp`` with jobid environment variables attached</span>

<span class="sd">    :param commandfile: name of file with commandlines (required)</span>
<span class="sd">    :param cores: number of cores (keyword, optional, default=1)</span>
<span class="sd">    :param workdir: directory for output and temporary files (optional, keyword, default uses the job number); the launcher refuses to reuse an already existing directory</span>
<span class="sd">    :param debug: debug types string (optional, keyword)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jobid</span> <span class="o">=</span> <span class="n">JobId</span><span class="p">()</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">workdir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;workdir&quot;</span><span class="p">,</span><span class="s">&quot;pylauncher_tmp&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">cores</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;cores&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">LauncherJob</span><span class="p">(</span>
        <span class="n">hostpool</span><span class="o">=</span><span class="n">HostPool</span><span class="p">(</span> <span class="n">hostlist</span><span class="o">=</span><span class="n">HostListByName</span><span class="p">(),</span>
            <span class="n">commandexecutor</span><span class="o">=</span><span class="n">SSHExecutor</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span> <span class="p">),</span>
        <span class="n">taskgenerator</span><span class="o">=</span><span class="n">TaskGenerator</span><span class="p">(</span> 
            <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="n">commandfile</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="n">cores</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">),</span>
            <span class="n">completion</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">FileCompletion</span><span class="p">(</span> <span class="n">taskid</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                                    <span class="n">stamproot</span><span class="o">=</span><span class="s">&quot;expire&quot;</span><span class="p">,</span><span class="n">stampdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">),</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span> <span class="p">),</span>
        <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">job</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">job</span><span class="o">.</span><span class="n">final_report</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="IbrunLauncher"><a class="viewcode-back" href="../extend.html#pylauncher.IbrunLauncher">[docs]</a><span class="k">def</span> <span class="nf">IbrunLauncher</span><span class="p">(</span><span class="n">commandfile</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A LauncherJob for a file of small MPI jobs.</span>

<span class="sd">    The following values are specified for your convenience:</span>

<span class="sd">    * hostpool : based on HostListByName</span>
<span class="sd">    * commandexecutor : IbrunExecutor</span>
<span class="sd">    * taskgenerator : based on the ``commandfile`` argument</span>
<span class="sd">    * completion : based on a directory ``pylauncher_tmp`` with jobid environment variables attached</span>

<span class="sd">    :param commandfile: name of file with commandlines (required)</span>
<span class="sd">    :param cores: number of cores (keyword, optional, default=4, see ``FileCommandlineGenerator`` for more explanation)</span>
<span class="sd">    :param workdir: directory for output and temporary files (optional, keyword, default uses the job number); the launcher refuses to reuse an already existing directory</span>
<span class="sd">    :param debug: debug types string (optional, keyword)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jobid</span> <span class="o">=</span> <span class="n">JobId</span><span class="p">()</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">workdir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;workdir&quot;</span><span class="p">,</span><span class="s">&quot;pylauncher_tmp&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">cores</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;cores&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">LauncherJob</span><span class="p">(</span>
        <span class="n">hostpool</span><span class="o">=</span><span class="n">HostPool</span><span class="p">(</span> <span class="n">hostlist</span><span class="o">=</span><span class="n">HostListByName</span><span class="p">(),</span>
            <span class="n">commandexecutor</span><span class="o">=</span><span class="n">IbrunExecutor</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span> <span class="p">),</span>
        <span class="n">taskgenerator</span><span class="o">=</span><span class="n">TaskGenerator</span><span class="p">(</span> 
            <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="n">commandfile</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="n">cores</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">),</span>
            <span class="n">completion</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">FileCompletion</span><span class="p">(</span><span class="n">taskid</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                                      <span class="n">stamproot</span><span class="o">=</span><span class="s">&quot;expire&quot;</span><span class="p">,</span><span class="n">stampdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">),</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span> <span class="p">),</span>
        <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">job</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">job</span><span class="o">.</span><span class="n">final_report</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="MICLauncher"><a class="viewcode-back" href="../extend.html#pylauncher.MICLauncher">[docs]</a><span class="k">def</span> <span class="nf">MICLauncher</span><span class="p">(</span><span class="n">commandfile</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A LauncherJob for execution entirely on an Intel Xeon Phi.</span>

<span class="sd">    See ``ClassicLauncher`` for an explanation of the parameters.</span>
<span class="sd">    The only difference is in the use of a LocalExecutor.</span>
<span class="sd">    Treatment of the MIC cores is handled in the ``HostListByName``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jobid</span> <span class="o">=</span> <span class="n">JobId</span><span class="p">()</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;debug&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">workdir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;workdir&quot;</span><span class="p">,</span><span class="s">&quot;pylauncher_tmp&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">cores</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;cores&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">job</span> <span class="o">=</span> <span class="n">LauncherJob</span><span class="p">(</span>
        <span class="n">hostpool</span><span class="o">=</span><span class="n">HostPool</span><span class="p">(</span> <span class="n">hostlist</span><span class="o">=</span><span class="n">HostListByName</span><span class="p">(),</span>
            <span class="n">commandexecutor</span><span class="o">=</span><span class="n">LocalExecutor</span><span class="p">(</span>
                <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;/bin/sh &quot;</span><span class="p">,</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">),</span> 
                           <span class="n">debug</span><span class="o">=</span><span class="n">debug</span> <span class="p">),</span>
        <span class="n">taskgenerator</span><span class="o">=</span><span class="n">TaskGenerator</span><span class="p">(</span> 
            <span class="n">FileCommandlineGenerator</span><span class="p">(</span><span class="n">commandfile</span><span class="p">,</span><span class="n">cores</span><span class="o">=</span><span class="n">cores</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">),</span>
            <span class="n">completion</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">FileCompletion</span><span class="p">(</span> <span class="n">taskid</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                                    <span class="n">stamproot</span><span class="o">=</span><span class="s">&quot;expire&quot;</span><span class="p">,</span><span class="n">stampdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">),</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span> <span class="p">),</span>
        <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">job</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">job</span><span class="o">.</span><span class="n">final_report</span><span class="p">()</span>
</div>
<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">PyLauncher 2.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Victor Eijkhout.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>